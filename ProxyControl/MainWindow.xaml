<Window
    x:Class="ProxyControl.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:local="clr-namespace:ProxyControl"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:models="clr-namespace:ProxyControl.Models"
    xmlns:tb="http://www.hardcodet.net/taskbar"
    xmlns:vm="clr-namespace:ProxyControl.ViewModels"
    Title="Proxy Control"
    Width="1450"
    Height="900"
    Background="{DynamicResource SurfaceDarkBrush}"
    Foreground="{DynamicResource ForegroundBrush}"
    WindowStartupLocation="CenterScreen"
    mc:Ignorable="d">

    <Window.DataContext>
        <vm:MainViewModel />
    </Window.DataContext>

    <Window.Resources>
        <local:BooleanToVisibilityConverter x:Key="BoolToVis" />
        <local:InverseBooleanToVisibilityConverter x:Key="InvBoolToVis" />
        <local:InverseBooleanConverter x:Key="InvBool" />
        <local:StatusColorConverter x:Key="StatusColor" />
        <local:ListToStringConverter x:Key="ListToStr" />
        <local:NullToBooleanConverter x:Key="NullToBool" />
        <local:ActionToBlockVisConverter x:Key="ActionToBlockVisConverter" />
        <local:EqualityConverter x:Key="EqualityConverter" />
        <local:StringEqualsConverter x:Key="StringEqualsConverter" />
        <local:ActionToProxyVisConverter x:Key="ActionToProxyVisConverter" />



        <!--  Modern Menu Styles  -->
        <Style x:Key="{x:Static MenuItem.SeparatorStyleKey}" TargetType="Separator">
            <Setter Property="Height" Value="1" />
            <Setter Property="Margin" Value="0,4,0,4" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Separator">
                        <Border BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1" />
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style TargetType="{x:Type ContextMenu}">
            <Setter Property="SnapsToDevicePixels" Value="True" />
            <Setter Property="OverridesDefaultStyle" Value="True" />
            <Setter Property="Grid.IsSharedSizeScope" Value="true" />
            <Setter Property="HasDropShadow" Value="True" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type ContextMenu}">
                        <Border
                            x:Name="Border"
                            Padding="2"
                            Background="{DynamicResource SurfaceMediumBrush}"
                            BorderBrush="{DynamicResource BorderBrush}"
                            BorderThickness="1"
                            CornerRadius="6">
                            <Border.Effect>
                                <DropShadowEffect
                                    BlurRadius="10"
                                    Opacity="0.4"
                                    ShadowDepth="4"
                                    Color="Black" />
                            </Border.Effect>
                            <StackPanel IsItemsHost="True" KeyboardNavigation.DirectionalNavigation="Cycle" />
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <ControlTemplate x:Key="{x:Static MenuItem.TopLevelHeaderTemplateKey}" TargetType="MenuItem">
            <Border x:Name="Border">
                <Grid>
                    <ContentPresenter
                        Margin="12,6"
                        ContentSource="Header"
                        RecognizesAccessKey="True" />
                    <Popup
                        x:Name="Popup"
                        AllowsTransparency="True"
                        Focusable="False"
                        IsOpen="{Binding IsSubmenuOpen, RelativeSource={RelativeSource TemplatedParent}}"
                        Placement="Bottom"
                        PopupAnimation="Fade"
                        VerticalOffset="0">
                        <Border
                            x:Name="SubmenuBorder"
                            Padding="2"
                            Background="{DynamicResource SurfaceMediumBrush}"
                            BorderBrush="{DynamicResource BorderBrush}"
                            BorderThickness="1"
                            CornerRadius="6"
                            SnapsToDevicePixels="True">
                            <Border.Effect>
                                <DropShadowEffect
                                    BlurRadius="10"
                                    Opacity="0.4"
                                    ShadowDepth="4"
                                    Color="Black" />
                            </Border.Effect>
                            <StackPanel IsItemsHost="True" KeyboardNavigation.DirectionalNavigation="Cycle" />
                        </Border>
                    </Popup>
                </Grid>
            </Border>
            <ControlTemplate.Triggers>
                <Trigger Property="IsSuspendingPopupAnimation" Value="true">
                    <Setter TargetName="Popup" Property="PopupAnimation" Value="None" />
                </Trigger>
                <Trigger Property="IsHighlighted" Value="true">
                    <Setter TargetName="Border" Property="Background" Value="{DynamicResource SurfaceLightBrush}" />
                    <Setter TargetName="Border" Property="CornerRadius" Value="4" />
                </Trigger>
                <Trigger SourceName="Popup" Property="AllowsTransparency" Value="True">
                    <Setter TargetName="SubmenuBorder" Property="CornerRadius" Value="6" />
                    <Setter TargetName="SubmenuBorder" Property="Padding" Value="0,3,0,3" />
                </Trigger>
                <Trigger Property="IsEnabled" Value="False">
                    <Setter Property="Foreground" Value="{DynamicResource ForegroundDisabledBrush}" />
                </Trigger>
            </ControlTemplate.Triggers>
        </ControlTemplate>

        <ControlTemplate x:Key="{x:Static MenuItem.TopLevelItemTemplateKey}" TargetType="MenuItem">
            <Border x:Name="Border">
                <Grid>
                    <ContentPresenter
                        Margin="12,6"
                        ContentSource="Header"
                        RecognizesAccessKey="True" />
                </Grid>
            </Border>
            <ControlTemplate.Triggers>
                <Trigger Property="IsHighlighted" Value="true">
                    <Setter TargetName="Border" Property="Background" Value="{DynamicResource SurfaceLightBrush}" />
                    <Setter TargetName="Border" Property="CornerRadius" Value="4" />
                </Trigger>
                <Trigger Property="IsEnabled" Value="False">
                    <Setter Property="Foreground" Value="{DynamicResource ForegroundDisabledBrush}" />
                </Trigger>
            </ControlTemplate.Triggers>
        </ControlTemplate>

        <ControlTemplate x:Key="{x:Static MenuItem.SubmenuHeaderTemplateKey}" TargetType="MenuItem">
            <Border x:Name="Border" Padding="4,2">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" SharedSizeGroup="Icon" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" SharedSizeGroup="Shortcut" />
                        <ColumnDefinition Width="13" />
                    </Grid.ColumnDefinitions>
                    <ContentPresenter
                        x:Name="Icon"
                        Margin="6,0,6,0"
                        VerticalAlignment="Center"
                        ContentSource="Icon" />
                    <ContentPresenter
                        x:Name="HeaderHost"
                        Grid.Column="1"
                        VerticalAlignment="Center"
                        ContentSource="Header"
                        RecognizesAccessKey="True" />
                    <TextBlock
                        x:Name="InputGestureText"
                        Grid.Column="2"
                        Margin="10,2,2,2"
                        VerticalAlignment="Center"
                        DockPanel.Dock="Right"
                        Text="{TemplateBinding InputGestureText}" />
                    <Path
                        Grid.Column="3"
                        VerticalAlignment="Center"
                        Data="M 0,0 L 4,3.5 L 0,7 Z"
                        Fill="{DynamicResource IconBrush}" />
                    <Popup
                        x:Name="Popup"
                        AllowsTransparency="True"
                        Focusable="False"
                        HorizontalOffset="-2"
                        IsOpen="{Binding IsSubmenuOpen, RelativeSource={RelativeSource TemplatedParent}}"
                        Placement="Right"
                        PopupAnimation="Fade">
                        <Border
                            x:Name="SubmenuBorder"
                            Padding="2"
                            Background="{DynamicResource SurfaceMediumBrush}"
                            BorderBrush="{DynamicResource BorderBrush}"
                            BorderThickness="1"
                            CornerRadius="6"
                            SnapsToDevicePixels="True">
                            <Border.Effect>
                                <DropShadowEffect
                                    BlurRadius="10"
                                    Opacity="0.4"
                                    ShadowDepth="4"
                                    Color="Black" />
                            </Border.Effect>
                            <StackPanel IsItemsHost="True" KeyboardNavigation.DirectionalNavigation="Cycle" />
                        </Border>
                    </Popup>
                </Grid>
            </Border>
            <ControlTemplate.Triggers>
                <Trigger Property="IsHighlighted" Value="true">
                    <Setter TargetName="Border" Property="Background" Value="#6366F1" />
                    <Setter TargetName="Border" Property="CornerRadius" Value="4" />
                    <Setter Property="Foreground" Value="White" />
                </Trigger>
                <Trigger Property="IsEnabled" Value="False">
                    <Setter Property="Foreground" Value="{DynamicResource ForegroundDisabledBrush}" />
                </Trigger>
            </ControlTemplate.Triggers>
        </ControlTemplate>

        <ControlTemplate x:Key="{x:Static MenuItem.SubmenuItemTemplateKey}" TargetType="MenuItem">
            <Border x:Name="Border" Padding="4,2">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" SharedSizeGroup="Icon" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" SharedSizeGroup="Shortcut" />
                        <ColumnDefinition Width="13" />
                    </Grid.ColumnDefinitions>
                    <ContentPresenter
                        x:Name="Icon"
                        Margin="6,0,6,0"
                        VerticalAlignment="Center"
                        ContentSource="Icon" />
                    <Border
                        x:Name="Check"
                        Width="13"
                        Height="13"
                        Margin="6,0,6,0"
                        VerticalAlignment="Center"
                        BorderThickness="1"
                        CornerRadius="3"
                        Visibility="Collapsed">
                        <Path
                            x:Name="CheckMark"
                            VerticalAlignment="Center"
                            Data="M 0,5 L 3,8 L 9,0"
                            Stroke="White"
                            StrokeThickness="2"
                            Visibility="Hidden" />
                    </Border>
                    <ContentPresenter
                        x:Name="HeaderHost"
                        Grid.Column="1"
                        VerticalAlignment="Center"
                        ContentSource="Header"
                        RecognizesAccessKey="True" />
                </Grid>
            </Border>
            <ControlTemplate.Triggers>
                <Trigger Property="IsChecked" Value="True">
                    <Setter TargetName="Check" Property="Visibility" Value="Visible" />
                    <Setter TargetName="Check" Property="Background" Value="{DynamicResource PrimaryAccentBrush}" />
                    <Setter TargetName="Check" Property="BorderBrush" Value="{DynamicResource PrimaryAccentBrush}" />
                    <Setter TargetName="CheckMark" Property="Visibility" Value="Visible" />
                    <Setter TargetName="Icon" Property="Visibility" Value="Hidden" />
                </Trigger>
                <Trigger Property="IsHighlighted" Value="true">
                    <Setter TargetName="Border" Property="Background" Value="#6366F1" />
                    <Setter TargetName="Border" Property="CornerRadius" Value="4" />
                    <Setter Property="Foreground" Value="White" />
                </Trigger>
                <Trigger Property="IsEnabled" Value="False">
                    <Setter Property="Foreground" Value="{DynamicResource ForegroundDisabledBrush}" />
                </Trigger>
            </ControlTemplate.Triggers>
        </ControlTemplate>

        <Style TargetType="{x:Type MenuItem}">
            <Setter Property="OverridesDefaultStyle" Value="True" />
            <Setter Property="Foreground" Value="{DynamicResource ForegroundBrush}" />
            <Setter Property="FontSize" Value="13" />
            <Setter Property="Padding" Value="6,4" />
            <Setter Property="Template" Value="{StaticResource {x:Static MenuItem.SubmenuItemTemplateKey}}" />
            <Style.Triggers>
                <Trigger Property="Role" Value="TopLevelHeader">
                    <Setter Property="Template" Value="{StaticResource {x:Static MenuItem.TopLevelHeaderTemplateKey}}" />
                    <Setter Property="Padding" Value="12,6" />
                </Trigger>
                <Trigger Property="Role" Value="TopLevelItem">
                    <Setter Property="Template" Value="{StaticResource {x:Static MenuItem.TopLevelItemTemplateKey}}" />
                    <Setter Property="Padding" Value="12,6" />
                </Trigger>
                <Trigger Property="Role" Value="SubmenuHeader">
                    <Setter Property="Template" Value="{StaticResource {x:Static MenuItem.SubmenuHeaderTemplateKey}}" />
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style TargetType="DataGridColumnHeader">
            <Setter Property="Background">
                <Setter.Value>
                    <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                        <GradientStop Offset="0" Color="{DynamicResource SurfaceLight}" />
                        <GradientStop Offset="1" Color="{DynamicResource SurfaceMedium}" />
                    </LinearGradientBrush>
                </Setter.Value>
            </Setter>
            <Setter Property="Foreground" Value="#A1A1AA" />
            <Setter Property="Padding" Value="12,10" />
            <Setter Property="FontSize" Value="11" />
            <Setter Property="FontWeight" Value="SemiBold" />
            <Setter Property="MinHeight" Value="36" />
            <Setter Property="BorderThickness" Value="0,0,1,1" />
            <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}" />
        </Style>

        <Style TargetType="TextBox">
            <Setter Property="Background" Value="{DynamicResource SurfaceLightBrush}" />
            <Setter Property="Foreground" Value="{DynamicResource ForegroundBrush}" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}" />
            <Setter Property="Padding" Value="10,8" />
            <Setter Property="FontSize" Value="13" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="TextBox">
                        <Border
                            x:Name="border"
                            Background="{TemplateBinding Background}"
                            BorderBrush="{TemplateBinding BorderBrush}"
                            BorderThickness="{TemplateBinding BorderThickness}"
                            CornerRadius="6">
                            <ScrollViewer
                                x:Name="PART_ContentHost"
                                Margin="{TemplateBinding Padding}"
                                VerticalAlignment="Center" />
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsFocused" Value="True">
                                <Setter TargetName="border" Property="BorderBrush" Value="{DynamicResource PrimaryAccentBrush}" />
                                <Setter TargetName="border" Property="Background" Value="{DynamicResource SurfaceMediumBrush}" />
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="BorderBrush" Value="{DynamicResource ForegroundDisabledBrush}" />
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style TargetType="Button">
            <Setter Property="Background" Value="{DynamicResource SurfaceLightBrush}" />
            <Setter Property="Foreground" Value="{DynamicResource ForegroundBrush}" />
            <Setter Property="FontWeight" Value="Medium" />
            <Setter Property="FontSize" Value="13" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border
                            x:Name="border"
                            Background="{TemplateBinding Background}"
                            BorderBrush="{DynamicResource BorderBrush}"
                            BorderThickness="1"
                            CornerRadius="6">
                            <ContentPresenter
                                Margin="14,8"
                                HorizontalAlignment="Center"
                                VerticalAlignment="Center" />
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{DynamicResource BorderBrush}" />
                                <Setter TargetName="border" Property="BorderBrush" Value="{DynamicResource ForegroundDisabledBrush}" />
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{DynamicResource ForegroundDisabledBrush}" />
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style
            x:Key="AccentBtn"
            BasedOn="{StaticResource {x:Type Button}}"
            TargetType="Button">
            <Setter Property="Background" Value="{DynamicResource AccentGradient}" />
            <Setter Property="Foreground" Value="White" />
            <Setter Property="FontWeight" Value="SemiBold" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border
                            x:Name="border"
                            Background="{TemplateBinding Background}"
                            BorderThickness="0"
                            CornerRadius="6">
                            <ContentPresenter
                                Margin="14,8"
                                HorizontalAlignment="Center"
                                VerticalAlignment="Center" />
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Opacity" Value="0.9" />
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Opacity" Value="0.8" />
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style
            x:Key="DangerBtn"
            BasedOn="{StaticResource {x:Type Button}}"
            TargetType="Button">
            <Setter Property="Background" Value="#DC2626" />
            <Setter Property="Foreground" Value="White" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border
                            x:Name="border"
                            Background="{TemplateBinding Background}"
                            BorderThickness="0"
                            CornerRadius="6">
                            <ContentPresenter
                                Margin="14,8"
                                HorizontalAlignment="Center"
                                VerticalAlignment="Center" />
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#EF4444" />
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#B91C1C" />
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style
            x:Key="SuccessBtn"
            BasedOn="{StaticResource {x:Type Button}}"
            TargetType="Button">
            <Setter Property="Background" Value="#059669" />
            <Setter Property="Foreground" Value="White" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border
                            x:Name="border"
                            Background="{TemplateBinding Background}"
                            BorderThickness="0"
                            CornerRadius="6">
                            <ContentPresenter
                                Margin="14,8"
                                HorizontalAlignment="Center"
                                VerticalAlignment="Center" />
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#10B981" />
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#047857" />
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="ActionButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="{DynamicResource AccentGradient}" />
            <Setter Property="Foreground" Value="White" />
            <Setter Property="FontSize" Value="11" />
            <Setter Property="FontWeight" Value="SemiBold" />
            <Setter Property="Padding" Value="10,4" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="Cursor" Value="Hand" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border
                            x:Name="Border"
                            Background="{TemplateBinding Background}"
                            CornerRadius="4">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Border" Property="Opacity" Value="0.85" />
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="Border" Property="Opacity" Value="0.7" />
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!--  Card Style  -->
        <Style x:Key="CardStyle" TargetType="Border">
            <Setter Property="Background" Value="{DynamicResource SurfaceMediumBrush}" />
            <Setter Property="BorderBrush" Value="{DynamicResource SurfaceLightBrush}" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="CornerRadius" Value="8" />
            <Setter Property="Padding" Value="16" />
        </Style>

        <!--  Modern ComboBox Style  -->
        <ControlTemplate x:Key="ModernComboBoxToggleButton" TargetType="ToggleButton">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition />
                    <ColumnDefinition Width="32" />
                </Grid.ColumnDefinitions>
                <Border
                    x:Name="Border"
                    Grid.ColumnSpan="2"
                    Background="{DynamicResource SurfaceLightBrush}"
                    BorderBrush="{DynamicResource BorderBrush}"
                    BorderThickness="1"
                    CornerRadius="6" />
                <Path
                    x:Name="Arrow"
                    Grid.Column="1"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    Data="M0,0 L4,4 L8,0"
                    Fill="{DynamicResource IconBrush}"
                    Stroke="{DynamicResource IconBrush}"
                    StrokeThickness="1.5" />
            </Grid>
            <ControlTemplate.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter TargetName="Border" Property="BorderBrush" Value="{DynamicResource ForegroundDisabledBrush}" />
                    <Setter TargetName="Border" Property="Background" Value="#2D2D32" />
                </Trigger>
                <Trigger Property="IsChecked" Value="True">
                    <Setter TargetName="Border" Property="BorderBrush" Value="{DynamicResource PrimaryAccentBrush}" />
                </Trigger>
            </ControlTemplate.Triggers>
        </ControlTemplate>

        <Style TargetType="ComboBox">
            <Setter Property="Background" Value="{DynamicResource SurfaceLightBrush}" />
            <Setter Property="Foreground" Value="{DynamicResource ForegroundBrush}" />
            <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="Padding" Value="10,8" />
            <Setter Property="FontSize" Value="13" />
            <Setter Property="MinHeight" Value="36" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ComboBox">
                        <Grid>
                            <ToggleButton
                                x:Name="ToggleButton"
                                ClickMode="Press"
                                Focusable="False"
                                IsChecked="{Binding IsDropDownOpen, Mode=TwoWay, RelativeSource={RelativeSource TemplatedParent}}"
                                Template="{StaticResource ModernComboBoxToggleButton}" />
                            <ContentPresenter
                                x:Name="ContentSite"
                                Margin="12,3,28,3"
                                HorizontalAlignment="Left"
                                VerticalAlignment="Center"
                                Content="{TemplateBinding SelectionBoxItem}"
                                ContentTemplate="{TemplateBinding SelectionBoxItemTemplate}"
                                ContentTemplateSelector="{TemplateBinding ItemTemplateSelector}"
                                IsHitTestVisible="False" />
                            <Popup
                                x:Name="Popup"
                                AllowsTransparency="True"
                                Focusable="False"
                                IsOpen="{TemplateBinding IsDropDownOpen}"
                                Placement="Bottom"
                                PopupAnimation="Slide">
                                <Grid
                                    x:Name="DropDown"
                                    MinWidth="{TemplateBinding ActualWidth}"
                                    MaxHeight="{TemplateBinding MaxDropDownHeight}"
                                    SnapsToDevicePixels="True">
                                    <Border
                                        x:Name="DropDownBorder"
                                        Margin="0,2,0,0"
                                        Background="{DynamicResource SurfaceMediumBrush}"
                                        BorderBrush="{DynamicResource BorderBrush}"
                                        BorderThickness="1"
                                        CornerRadius="6">
                                        <Border.Effect>
                                            <DropShadowEffect
                                                BlurRadius="12"
                                                Opacity="0.4"
                                                ShadowDepth="4"
                                                Color="Black" />
                                        </Border.Effect>
                                        <ScrollViewer Margin="4" SnapsToDevicePixels="True">
                                            <StackPanel IsItemsHost="True" KeyboardNavigation.DirectionalNavigation="Contained" />
                                        </ScrollViewer>
                                    </Border>
                                </Grid>
                            </Popup>
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style TargetType="ComboBoxItem">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="Foreground" Value="{DynamicResource ForegroundBrush}" />
            <Setter Property="Padding" Value="10,8" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ComboBoxItem">
                        <Border
                            x:Name="Border"
                            Padding="{TemplateBinding Padding}"
                            Background="{TemplateBinding Background}"
                            CornerRadius="4">
                            <ContentPresenter />
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsHighlighted" Value="True">
                                <Setter TargetName="Border" Property="Background" Value="{DynamicResource BorderBrush}" />
                            </Trigger>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter TargetName="Border" Property="Background" Value="{DynamicResource PrimaryAccentBrush}" />
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!--  Modern Toggle Switch CheckBox Style  -->
        <Style x:Key="ToggleSwitchStyle" TargetType="CheckBox">
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="CheckBox">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>
                            <Border
                                x:Name="SwitchBorder"
                                Width="44"
                                Height="24"
                                Background="{DynamicResource BorderBrush}"
                                CornerRadius="12"
                                Cursor="Hand">
                                <Ellipse
                                    x:Name="SwitchThumb"
                                    Width="18"
                                    Height="18"
                                    Margin="3,0,0,0"
                                    HorizontalAlignment="Left"
                                    Fill="White" />
                            </Border>
                            <ContentPresenter
                                Grid.Column="1"
                                Margin="10,0,0,0"
                                VerticalAlignment="Center"
                                Content="{TemplateBinding Content}" />
                        </Grid>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="SwitchBorder" Property="Background" Value="{DynamicResource PrimaryAccentBrush}" />
                                <Setter TargetName="SwitchThumb" Property="Margin" Value="23,0,0,0" />
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="SwitchBorder" Property="Opacity" Value="0.9" />
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!--  Modern CheckBox Style  -->
        <Style TargetType="CheckBox">
            <Setter Property="Foreground" Value="{DynamicResource ForegroundBrush}" />
            <Setter Property="FontSize" Value="13" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="CheckBox">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>
                            <Border
                                x:Name="CheckBorder"
                                Width="20"
                                Height="20"
                                Background="{DynamicResource SurfaceLightBrush}"
                                BorderBrush="{DynamicResource BorderBrush}"
                                BorderThickness="1.5"
                                CornerRadius="4"
                                Cursor="Hand">
                                <Path
                                    x:Name="CheckMark"
                                    HorizontalAlignment="Center"
                                    VerticalAlignment="Center"
                                    Data="M2,5 L5,8 L10,2"
                                    Opacity="0"
                                    Stroke="White"
                                    StrokeThickness="2" />
                            </Border>
                            <ContentPresenter
                                Grid.Column="1"
                                Margin="8,0,0,0"
                                VerticalAlignment="Center"
                                Content="{TemplateBinding Content}" />
                        </Grid>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="CheckBorder" Property="Background" Value="{DynamicResource PrimaryAccentBrush}" />
                                <Setter TargetName="CheckBorder" Property="BorderBrush" Value="{DynamicResource PrimaryAccentBrush}" />
                                <Setter TargetName="CheckMark" Property="Opacity" Value="1" />
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="CheckBorder" Property="BorderBrush" Value="{DynamicResource ForegroundDisabledBrush}" />
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!--  Section Header Style  -->
        <Style x:Key="SectionHeader" TargetType="TextBlock">
            <Setter Property="Foreground" Value="{DynamicResource ForegroundMutedBrush}" />
            <Setter Property="FontSize" Value="11" />
            <Setter Property="FontWeight" Value="SemiBold" />
            <Setter Property="Margin" Value="0,0,0,12" />
        </Style>

        <!--  Modern TabItem Style  -->
        <Style TargetType="TabItem">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="Foreground" Value="{DynamicResource ForegroundMutedBrush}" />
            <Setter Property="FontSize" Value="12" />
            <Setter Property="FontWeight" Value="Medium" />
            <Setter Property="Padding" Value="16,10" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="TabItem">
                        <Border
                            x:Name="border"
                            Padding="{TemplateBinding Padding}"
                            Background="{TemplateBinding Background}"
                            BorderBrush="Transparent"
                            BorderThickness="0,0,0,2">
                            <ContentPresenter
                                HorizontalAlignment="Center"
                                VerticalAlignment="Center"
                                ContentSource="Header" />
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter Property="Foreground" Value="{DynamicResource ForegroundBrush}" />
                                <Setter TargetName="border" Property="BorderBrush" Value="{DynamicResource PrimaryAccentBrush}" />
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Foreground" Value="#A1A1AA" />
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Window.Resources>

    <Grid>
        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="340" />
                <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>

            <tb:TaskbarIcon
                x:Name="TrayIcon"
                DoubleClickCommand="{Binding ShowWindowCommand}"
                IconSource="proxy.ico"
                MenuActivation="LeftOrRightClick"
                ToolTipText="Proxy Control">
                <tb:TaskbarIcon.ContextMenu>
                    <ContextMenu>
                        <ContextMenu.Resources>
                            <Style TargetType="MenuItem">
                                <Setter Property="Foreground" Value="{DynamicResource ForegroundBrush}" />
                                <Setter Property="FontSize" Value="13" />
                                <Setter Property="Padding" Value="12,8" />
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="MenuItem">
                                            <Border
                                                x:Name="Border"
                                                Padding="{TemplateBinding Padding}"
                                                Background="Transparent"
                                                SnapsToDevicePixels="True">
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="Auto" SharedSizeGroup="Icon" />
                                                        <ColumnDefinition Width="*" />
                                                    </Grid.ColumnDefinitions>
                                                    <ContentPresenter
                                                        x:Name="Icon"
                                                        Margin="0,0,8,0"
                                                        VerticalAlignment="Center"
                                                        ContentSource="Icon" />
                                                    <Path
                                                        x:Name="CheckMark"
                                                        Margin="0,0,8,0"
                                                        HorizontalAlignment="Center"
                                                        VerticalAlignment="Center"
                                                        Data="M0,4 L3,7 L8,0"
                                                        Stroke="#10B981"
                                                        StrokeThickness="2"
                                                        Visibility="Collapsed" />
                                                    <ContentPresenter
                                                        Grid.Column="1"
                                                        VerticalAlignment="Center"
                                                        ContentSource="Header"
                                                        RecognizesAccessKey="True" />
                                                </Grid>
                                            </Border>
                                            <ControlTemplate.Triggers>
                                                <Trigger Property="IsHighlighted" Value="True">
                                                    <Setter TargetName="Border" Property="Background" Value="{DynamicResource SurfaceLightBrush}" />
                                                </Trigger>
                                                <Trigger Property="IsChecked" Value="True">
                                                    <Setter TargetName="CheckMark" Property="Visibility" Value="Visible" />
                                                    <Setter TargetName="Icon" Property="Visibility" Value="Collapsed" />
                                                </Trigger>
                                                <Trigger Property="IsEnabled" Value="False">
                                                    <Setter Property="Foreground" Value="{DynamicResource ForegroundDisabledBrush}" />
                                                </Trigger>
                                            </ControlTemplate.Triggers>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                            <Style TargetType="Separator">
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="Separator">
                                            <Border
                                                Margin="0,4"
                                                BorderBrush="{DynamicResource BorderBrush}"
                                                BorderThickness="0,1,0,0" />
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </ContextMenu.Resources>

                        <ContextMenu.Template>
                            <ControlTemplate TargetType="ContextMenu">
                                <Border
                                    Padding="4"
                                    Background="{DynamicResource SurfaceMediumBrush}"
                                    BorderBrush="{DynamicResource BorderBrush}"
                                    BorderThickness="1"
                                    CornerRadius="8">
                                    <Border.Effect>
                                        <DropShadowEffect
                                            BlurRadius="12"
                                            Opacity="0.5"
                                            ShadowDepth="4" />
                                    </Border.Effect>
                                    <StackPanel IsItemsHost="True" />
                                </Border>
                            </ControlTemplate>
                        </ContextMenu.Template>

                        <MenuItem Command="{Binding ShowWindowCommand}" Header="Open" />
                        <MenuItem Command="{Binding ToggleProxyCommand}" Header="{Binding ToggleProxyMenuText}" />
                        <Separator />

                        <MenuItem Header="Routing Mode">
                            <MenuItem.Template>
                                <ControlTemplate TargetType="MenuItem">
                                    <Border
                                        x:Name="Border"
                                        Padding="12,8"
                                        Background="Transparent">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="Auto" />
                                            </Grid.ColumnDefinitions>
                                            <ContentPresenter VerticalAlignment="Center" ContentSource="Header" />
                                            <Path
                                                Grid.Column="1"
                                                Margin="8,0,0,0"
                                                VerticalAlignment="Center"
                                                Data="M0,0 L4,4 L0,8"
                                                Stroke="{DynamicResource IconBrush}"
                                                StrokeThickness="1" />
                                            <Popup
                                                x:Name="Popup"
                                                AllowsTransparency="True"
                                                Focusable="False"
                                                IsOpen="{Binding IsSubmenuOpen, RelativeSource={RelativeSource TemplatedParent}}"
                                                Placement="Right"
                                                PopupAnimation="Fade">
                                                <Border
                                                    Margin="4,0,0,0"
                                                    Padding="4"
                                                    Background="{DynamicResource SurfaceMediumBrush}"
                                                    BorderBrush="{DynamicResource BorderBrush}"
                                                    BorderThickness="1"
                                                    CornerRadius="8">
                                                    <StackPanel IsItemsHost="True" />
                                                </Border>
                                            </Popup>
                                        </Grid>
                                    </Border>
                                    <ControlTemplate.Triggers>
                                        <Trigger Property="IsHighlighted" Value="True">
                                            <Setter TargetName="Border" Property="Background" Value="{DynamicResource SurfaceLightBrush}" />
                                        </Trigger>
                                    </ControlTemplate.Triggers>
                                </ControlTemplate>
                            </MenuItem.Template>
                            <MenuItem
                                Command="{Binding TraySetBlackListModeCommand}"
                                Header="BlackList Mode"
                                IsCheckable="True"
                                IsChecked="{Binding IsBlackListMode}" />
                            <MenuItem
                                Command="{Binding TraySetWhiteListModeCommand}"
                                Header="WhiteList Mode"
                                IsCheckable="True"
                                IsChecked="{Binding IsBlackListMode, Converter={StaticResource InvBool}}" />
                        </MenuItem>



                        <MenuItem
                            Header="Select Main Proxy"
                            ItemsSource="{Binding Proxies}"
                            Visibility="{Binding IsBlackListMode, Converter={StaticResource BoolToVis}}">
                            <MenuItem.Template>
                                <ControlTemplate TargetType="MenuItem">
                                    <Border
                                        x:Name="Border"
                                        Padding="12,8"
                                        Background="Transparent">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="Auto" />
                                            </Grid.ColumnDefinitions>
                                            <ContentPresenter VerticalAlignment="Center" ContentSource="Header" />
                                            <Path
                                                Grid.Column="1"
                                                Margin="8,0,0,0"
                                                VerticalAlignment="Center"
                                                Data="M0,0 L4,4 L0,8"
                                                Stroke="{DynamicResource IconBrush}"
                                                StrokeThickness="1" />

                                            <Popup
                                                x:Name="Popup"
                                                AllowsTransparency="True"
                                                Focusable="False"
                                                IsOpen="{Binding IsSubmenuOpen, RelativeSource={RelativeSource TemplatedParent}}"
                                                Placement="Right"
                                                PopupAnimation="Fade">
                                                <Border
                                                    Margin="4,0,0,0"
                                                    Padding="4"
                                                    Background="{DynamicResource SurfaceMediumBrush}"
                                                    BorderBrush="{DynamicResource BorderBrush}"
                                                    BorderThickness="1"
                                                    CornerRadius="8">
                                                    <StackPanel IsItemsHost="True" />
                                                </Border>
                                            </Popup>
                                        </Grid>
                                    </Border>
                                    <ControlTemplate.Triggers>
                                        <Trigger Property="IsHighlighted" Value="True">
                                            <Setter TargetName="Border" Property="Background" Value="{DynamicResource SurfaceLightBrush}" />
                                        </Trigger>
                                    </ControlTemplate.Triggers>
                                </ControlTemplate>
                            </MenuItem.Template>
                            <MenuItem.ItemContainerStyle>
                                <Style TargetType="MenuItem">
                                    <Setter Property="Header" Value="{Binding IpAddress}" />
                                    <Setter Property="Command" Value="{Binding DataContext.TraySelectProxyCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}" />
                                    <Setter Property="CommandParameter" Value="{Binding}" />
                                    <Setter Property="IsCheckable" Value="True" />
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="MenuItem">
                                                <Border
                                                    x:Name="Border"
                                                    Padding="12,8"
                                                    Background="Transparent">
                                                    <Grid>
                                                        <Grid.ColumnDefinitions>
                                                            <ColumnDefinition Width="Auto" />
                                                            <ColumnDefinition Width="*" />
                                                        </Grid.ColumnDefinitions>
                                                        <Path
                                                            x:Name="CheckMark"
                                                            Margin="0,0,8,0"
                                                            VerticalAlignment="Center"
                                                            Data="M0,4 L3,7 L8,0"
                                                            Stroke="#10B981"
                                                            StrokeThickness="2"
                                                            Visibility="Hidden" />
                                                        <ContentPresenter
                                                            Grid.Column="1"
                                                            VerticalAlignment="Center"
                                                            ContentSource="Header" />
                                                    </Grid>
                                                </Border>
                                                <ControlTemplate.Triggers>
                                                    <Trigger Property="IsChecked" Value="True">
                                                        <Setter TargetName="CheckMark" Property="Visibility" Value="Visible" />
                                                    </Trigger>
                                                    <Trigger Property="IsHighlighted" Value="True">
                                                        <Setter TargetName="Border" Property="Background" Value="{DynamicResource SurfaceLightBrush}" />
                                                    </Trigger>
                                                </ControlTemplate.Triggers>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                    <Style.Triggers>
                                        <DataTrigger Value="True">
                                            <DataTrigger.Binding>
                                                <MultiBinding Converter="{StaticResource EqualityConverter}">
                                                    <Binding Path="DataContext.SelectedBlackListMainProxy.Id" RelativeSource="{RelativeSource AncestorType=ContextMenu}" />
                                                    <Binding Path="Id" />
                                                </MultiBinding>
                                            </DataTrigger.Binding>
                                            <Setter Property="IsChecked" Value="True" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </MenuItem.ItemContainerStyle>
                        </MenuItem>

                        <Separator />
                        <MenuItem Command="{Binding ExitAppCommand}" Header="Exit" />
                    </ContextMenu>
                </tb:TaskbarIcon.ContextMenu>
            </tb:TaskbarIcon>

            <Border
                Grid.Column="0"
                Background="{DynamicResource SurfaceMediumBrush}"
                BorderBrush="#27272A"
                BorderThickness="0,0,1,0">
                <Grid Margin="12">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>

                    <!--  Header  -->
                    <Grid Grid.Row="0" Margin="0,0,0,12">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>
                        <TextBlock
                            FontSize="11"
                            FontWeight="SemiBold"
                            Foreground="{DynamicResource ForegroundMutedBrush}"
                            Text="PROXIES" />
                        <!--  Old Add Proxy Button Removed  -->
                    </Grid>



                    <ListBox
                        Grid.Row="2"
                        Background="Transparent"
                        BorderThickness="0"
                        Foreground="White"
                        ItemsSource="{Binding Proxies}"
                        SelectedItem="{Binding SelectedProxy}">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <Grid Margin="0,3">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>

                                    <CheckBox
                                        Margin="0,0,5,0"
                                        VerticalAlignment="Center"
                                        IsChecked="{Binding IsEnabled, UpdateSourceTrigger=PropertyChanged}" />

                                    <Image
                                        Grid.Column="1"
                                        Width="20"
                                        Height="15"
                                        Margin="0,0,5,0"
                                        VerticalAlignment="Center"
                                        RenderOptions.BitmapScalingMode="HighQuality"
                                        Source="{Binding FlagUrl}" />

                                    <StackPanel Grid.Column="2">
                                        <StackPanel Orientation="Horizontal">
                                            <Border
                                                Margin="0,0,5,0"
                                                Padding="3,0"
                                                VerticalAlignment="Center"
                                                Background="#444"
                                                CornerRadius="2">
                                                <TextBlock
                                                    FontSize="9"
                                                    FontWeight="Bold"
                                                    Foreground="#EEE"
                                                    Text="{Binding Type}" />
                                            </Border>
                                            <TextBlock FontWeight="Bold" Text="{Binding IpAddress, TargetNullValue='(No IP)'}" />
                                        </StackPanel>
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock
                                                Margin="0,0,5,0"
                                                FontSize="10"
                                                Foreground="#AAA"
                                                Text="{Binding Port, StringFormat=Port: {0}}" />
                                            <TextBlock
                                                Margin="0,0,5,0"
                                                FontSize="10"
                                                Foreground="#55AAFF"
                                                Text="{Binding PingFormatted}" />
                                            <TextBlock
                                                FontSize="10"
                                                Foreground="#55FF55"
                                                Text="{Binding SpeedFormatted}" />
                                        </StackPanel>
                                    </StackPanel>


                                    <Border
                                        Grid.Column="3"
                                        Margin="5,0"
                                        Padding="4,1"
                                        VerticalAlignment="Center"
                                        Background="#333"
                                        CornerRadius="3">
                                        <TextBlock
                                            FontSize="9"
                                            Foreground="{Binding Status, Converter={StaticResource StatusColor}}"
                                            Text="{Binding Status}" />
                                    </Border>

                                    <Button
                                        Grid.Column="4"
                                        Padding="0"
                                        Background="Transparent"
                                        BorderThickness="0"
                                        Command="{Binding DataContext.OpenEditProxyModalCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                        CommandParameter="{Binding}"
                                        Content="✏️"
                                        Cursor="Hand"
                                        FontSize="14"
                                        Foreground="#888"
                                        ToolTip="Edit Proxy" />
                                </Grid>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                    <StackPanel Grid.Row="3" Margin="0,10,0,0">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>
                            <Button
                                Margin="0,0,5,0"
                                Command="{Binding OpenAddProxyModalCommand}"
                                Content="➕ Add"
                                Style="{StaticResource AccentBtn}"
                                ToolTip="Add New Proxy" />
                            <Button
                                Grid.Column="1"
                                Margin="0,0,5,0"
                                Command="{Binding PasteProxyCommand}"
                                Content="📋 Paste"
                                ToolTip="Paste Proxy from Clipboard" />
                            <Button
                                Grid.Column="2"
                                Command="{Binding CheckProxyCommand}"
                                Content="🔍 Check"
                                ToolTip="Check Selected Proxy Connectivity" />
                        </Grid>
                        <Button
                            Margin="0,6,0,0"
                            Background="#7F1D1D"
                            Command="{Binding RemoveProxyCommand}"
                            Content="🗑️ Remove Selected" />
                    </StackPanel>
                </Grid>
            </Border>

            <Grid Grid.Column="1" Margin="10">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <!--  Navigation Bar  -->
                <Border
                    Grid.Row="0"
                    Margin="0,0,0,16"
                    Padding="4"
                    HorizontalAlignment="Center"
                    Background="{DynamicResource SurfaceMediumBrush}"
                    CornerRadius="8">
                    <StackPanel Orientation="Horizontal">
                        <StackPanel.Resources>
                            <Style BasedOn="{StaticResource {x:Type ToggleButton}}" TargetType="RadioButton">
                                <Setter Property="Width" Value="100" />
                                <Setter Property="Height" Value="32" />
                                <Setter Property="Margin" Value="2,0" />
                                <Setter Property="Background" Value="Transparent" />
                                <Setter Property="BorderThickness" Value="0" />
                                <Setter Property="Foreground" Value="{DynamicResource ForegroundMutedBrush}" />
                                <Setter Property="Cursor" Value="Hand" />
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="RadioButton">
                                            <Border Background="{TemplateBinding Background}" CornerRadius="6">
                                                <ContentPresenter
                                                    HorizontalAlignment="Center"
                                                    VerticalAlignment="Center"
                                                    TextElement.FontSize="13"
                                                    TextElement.FontWeight="Medium" />
                                            </Border>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                                <Style.Triggers>
                                    <Trigger Property="IsChecked" Value="True">
                                        <Setter Property="Background" Value="{DynamicResource SurfaceLightBrush}" />
                                        <Setter Property="Foreground" Value="White" />
                                    </Trigger>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter Property="Foreground" Value="#D4D4D8" />
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </StackPanel.Resources>

                        <RadioButton
                            Command="{Binding NavigateCommand}"
                            CommandParameter="Rules"
                            Content="Rules"
                            IsChecked="{Binding CurrentView, Converter={StaticResource StringEqualsConverter}, ConverterParameter='Rules', Mode=OneWay}" />
                        <RadioButton
                            Command="{Binding NavigateCommand}"
                            CommandParameter="Monitor"
                            Content="Monitor"
                            IsChecked="{Binding CurrentView, Converter={StaticResource StringEqualsConverter}, ConverterParameter='Monitor', Mode=OneWay}" />
                        <RadioButton
                            Command="{Binding NavigateCommand}"
                            CommandParameter="Logs"
                            Content="Logs"
                            IsChecked="{Binding CurrentView, Converter={StaticResource StringEqualsConverter}, ConverterParameter='Logs', Mode=OneWay}" />
                        <RadioButton
                            Command="{Binding NavigateCommand}"
                            CommandParameter="Settings"
                            Content="Settings"
                            IsChecked="{Binding CurrentView, Converter={StaticResource StringEqualsConverter}, ConverterParameter='Settings', Mode=OneWay}" />
                    </StackPanel>
                </Border>



                <TabControl
                    Grid.Row="1"
                    Background="Transparent"
                    BorderThickness="0"
                    SelectedValue="{Binding CurrentView}"
                    SelectedValuePath="Tag">
                    <TabControl.ItemContainerStyle>
                        <Style TargetType="TabItem">
                            <Setter Property="Visibility" Value="Collapsed" />
                            <Setter Property="Padding" Value="0" />
                            <Setter Property="Margin" Value="0" />
                            <Setter Property="BorderThickness" Value="0" />
                        </Style>
                    </TabControl.ItemContainerStyle>

                    <TabItem Header="RULES" Tag="Rules">
                        <Grid Margin="10">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="*" />
                                <RowDefinition Height="Auto" />
                            </Grid.RowDefinitions>

                            <!--  Move GroupBox Header content here directly or keep structure  -->
                            <StackPanel Grid.Row="0" Margin="0,0,0,10">
                                <StackPanel Orientation="Horizontal">
                                    <RadioButton
                                        Margin="0,0,15,0"
                                        Content="BlackList Mode"
                                        Foreground="White"
                                        IsChecked="{Binding IsBlackListMode}" />
                                    <RadioButton
                                        Content="WhiteList Mode"
                                        Foreground="White"
                                        IsChecked="{Binding IsBlackListMode, Converter={StaticResource InvBool}}" />
                                </StackPanel>
                                <StackPanel
                                    Margin="0,10,0,0"
                                    Orientation="Horizontal"
                                    Visibility="{Binding IsBlackListMode, Converter={StaticResource BoolToVis}}">
                                    <TextBlock
                                        Margin="0,0,10,0"
                                        VerticalAlignment="Center"
                                        Foreground="#999"
                                        Text="Default Gateway:" />
                                    <ComboBox
                                        Width="200"
                                        DisplayMemberPath="IpAddress"
                                        ItemsSource="{Binding Proxies}"
                                        SelectedItem="{Binding SelectedBlackListMainProxy}" />

                                    <!--  TUN Mode Toggle  -->
                                    <StackPanel
                                        Margin="15,0,0,0"
                                        VerticalAlignment="Center"
                                        Orientation="Horizontal"
                                        ToolTip="Route ALL traffic through proxy (Virtual Network Interface). Only available for SOCKS5 Proxy.">
                                        <TextBlock
                                            Margin="0,0,8,0"
                                            VerticalAlignment="Center"
                                            FontSize="12"
                                            Foreground="{DynamicResource ForegroundMutedBrush}"
                                            Text="TUN Mode (VPN):" />
                                        <CheckBox
                                            IsChecked="{Binding IsTunMode}"
                                            IsEnabled="{Binding CanEnableTunMode}"
                                            Style="{StaticResource ToggleSwitchStyle}" />

                                        <!--  Optional Status Indicator  -->
                                        <TextBlock
                                            Margin="8,0,0,0"
                                            VerticalAlignment="Center"
                                            FontSize="11"
                                            FontWeight="SemiBold"
                                            Foreground="{Binding IsTunMode, Converter={StaticResource StatusColor}}"
                                            Text="{Binding TunModeStatus}" />
                                    </StackPanel>
                                </StackPanel>
                            </StackPanel>

                            <Grid Grid.Row="1" Margin="0,0,0,10">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="*" />
                                </Grid.ColumnDefinitions>
                                <TextBlock
                                    Margin="0,0,10,0"
                                    VerticalAlignment="Center"
                                    Foreground="#AAA"
                                    Text="Search:" />
                                <TextBox
                                    Grid.Column="1"
                                    Padding="5"
                                    Background="#333"
                                    BorderThickness="0"
                                    Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}" />
                            </Grid>

                            <!--  Presets Toolbar  -->
                            <Grid Grid.Row="2" Margin="0,0,0,10">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="200" />
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>

                                <TextBlock
                                    Margin="0,0,10,0"
                                    VerticalAlignment="Center"
                                    Foreground="#AAA"
                                    Text="Presets:" />
                                <ComboBox
                                    Grid.Column="1"
                                    MinHeight="30"
                                    Margin="0,0,5,0"
                                    Padding="6,4"
                                    DisplayMemberPath="Name"
                                    ItemsSource="{Binding Presets}"
                                    SelectedItem="{Binding SelectedPreset}" />
                                <StackPanel
                                    Grid.Column="2"
                                    Margin="0,0,15,0"
                                    Orientation="Horizontal">
                                    <Button
                                        Margin="0,0,5,0"
                                        Padding="10,4"
                                        Command="{Binding LoadPresetCommand}"
                                        Content="📂 Load"
                                        FontSize="12"
                                        ToolTip="Load Selected Preset" />
                                    <Button
                                        Padding="8,4"
                                        Background="#7F1D1D"
                                        Command="{Binding DeletePresetCommand}"
                                        CommandParameter="{Binding SelectedPreset}"
                                        Content="🗑️"
                                        FontSize="12"
                                        ToolTip="Delete Preset" />
                                </StackPanel>

                                <StackPanel Grid.Column="4" Orientation="Horizontal">
                                    <TextBox
                                        Width="150"
                                        Margin="0,0,5,0"
                                        VerticalContentAlignment="Center"
                                        Text="{Binding PresetName, UpdateSourceTrigger=PropertyChanged}"
                                        ToolTip="Name for New Preset" />
                                    <Button
                                        Padding="10,4"
                                        Command="{Binding SavePresetCommand}"
                                        Content="💾 Save New"
                                        FontSize="12"
                                        Style="{StaticResource AccentBtn}" />
                                </StackPanel>
                            </Grid>


                            <!--  Rule Navigation: 3 Independent Scrollable Panels  -->
                            <Grid Grid.Row="3">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition
                                        Width="1*"
                                        MinWidth="150"
                                        MaxWidth="400" />
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition
                                        Width="1*"
                                        MinWidth="150"
                                        MaxWidth="400" />
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="3*" />
                                </Grid.ColumnDefinitions>

                                <!--  PANEL 1: Groups (own ScrollViewer)  -->
                                <Border
                                    Grid.Column="0"
                                    MinWidth="200"
                                    Padding="10"
                                    Background="{DynamicResource SurfaceMediumBrush}"
                                    CornerRadius="8">
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="*" />
                                        </Grid.RowDefinitions>
                                        <TextBlock
                                            Margin="0,0,0,12"
                                            FontSize="14"
                                            FontWeight="SemiBold"
                                            Foreground="{DynamicResource ForegroundBrush}"
                                            Text="📁 Groups" />
                                        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                                            <ItemsControl ItemsSource="{Binding RuleGroups}">
                                                <ItemsControl.ItemsPanel>
                                                    <ItemsPanelTemplate>
                                                        <VirtualizingStackPanel />
                                                    </ItemsPanelTemplate>
                                                </ItemsControl.ItemsPanel>
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <Border
                                                            Margin="0,0,0,6"
                                                            Padding="12,10"
                                                            CornerRadius="6"
                                                            Cursor="Hand">
                                                            <Border.Style>
                                                                <Style TargetType="Border">
                                                                    <Setter Property="Background" Value="{DynamicResource SurfaceLightBrush}" />
                                                                    <Style.Triggers>
                                                                        <Trigger Property="IsMouseOver" Value="True">
                                                                            <Setter Property="Background" Value="{DynamicResource BorderBrush}" />
                                                                        </Trigger>
                                                                        <DataTrigger Value="True">
                                                                            <DataTrigger.Binding>
                                                                                <MultiBinding Converter="{StaticResource EqualityConverter}">
                                                                                    <Binding Path="GroupName" />
                                                                                    <Binding Path="DataContext.SelectedGroupName" RelativeSource="{RelativeSource AncestorType=Window}" />
                                                                                </MultiBinding>
                                                                            </DataTrigger.Binding>
                                                                            <Setter Property="Background" Value="{DynamicResource PrimaryAccentBrush}" />
                                                                            <Setter Property="BorderBrush" Value="{DynamicResource PrimaryAccentBrush}" />
                                                                        </DataTrigger>
                                                                    </Style.Triggers>
                                                                </Style>
                                                            </Border.Style>
                                                            <Border.InputBindings>
                                                                <MouseBinding
                                                                    Command="{Binding DataContext.SelectGroupCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                                    CommandParameter="{Binding GroupName}"
                                                                    MouseAction="LeftClick" />
                                                            </Border.InputBindings>
                                                            <Grid>
                                                                <Grid.ColumnDefinitions>
                                                                    <ColumnDefinition Width="Auto" />
                                                                    <ColumnDefinition Width="*" />
                                                                    <ColumnDefinition Width="Auto" />
                                                                </Grid.ColumnDefinitions>

                                                                <!--  Icon  -->
                                                                <TextBlock
                                                                    Grid.Column="0"
                                                                    VerticalAlignment="Center"
                                                                    FontSize="18"
                                                                    Text="{Binding Icon}" />

                                                                <!--  Name & Buttons Stack  -->
                                                                <StackPanel
                                                                    Grid.Column="1"
                                                                    Margin="12,0,0,0"
                                                                    VerticalAlignment="Center">
                                                                    <TextBlock
                                                                        FontSize="13"
                                                                        FontWeight="Medium"
                                                                        Foreground="{DynamicResource ForegroundBrush}"
                                                                        Text="{Binding GroupName}"
                                                                        TextTrimming="CharacterEllipsis" />

                                                                    <!--  Action Buttons Moved Below Name  -->
                                                                    <StackPanel Margin="0,4,0,0" Orientation="Horizontal">
                                                                        <Button
                                                                            Padding="4,2"
                                                                            Background="Transparent"
                                                                            BorderThickness="0"
                                                                            Command="{Binding DataContext.EditGroupCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                                            CommandParameter="{Binding GroupName}"
                                                                            Content="✏️"
                                                                            Cursor="Hand"
                                                                            FontSize="11"
                                                                            Foreground="#AAA"
                                                                            ToolTip="Rename Group" />
                                                                        <Button
                                                                            Margin="8,0,0,0"
                                                                            Padding="4,2"
                                                                            Background="Transparent"
                                                                            BorderThickness="0"
                                                                            Command="{Binding DataContext.RemoveGroupCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                                            CommandParameter="{Binding GroupName}"
                                                                            Content="🗑️"
                                                                            Cursor="Hand"
                                                                            FontSize="11"
                                                                            Foreground="#EF4444"
                                                                            ToolTip="Delete Group" />
                                                                    </StackPanel>
                                                                </StackPanel>

                                                                <!--  Rule Count Badge  -->
                                                                <Border
                                                                    Grid.Column="2"
                                                                    Margin="0,0,5,0"
                                                                    Padding="8,3"
                                                                    VerticalAlignment="Center"
                                                                    Background="#10B981"
                                                                    CornerRadius="10">
                                                                    <TextBlock
                                                                        FontSize="10"
                                                                        Foreground="White"
                                                                        Text="{Binding RuleCount}" />
                                                                </Border>
                                                            </Grid>
                                                        </Border>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </ScrollViewer>
                                    </Grid>
                                </Border>

                                <GridSplitter
                                    Grid.Column="1"
                                    Width="4"
                                    HorizontalAlignment="Center"
                                    VerticalAlignment="Stretch"
                                    Background="{DynamicResource BorderBrush}"
                                    ResizeBehavior="PreviousAndNext" />

                                <!--  PANEL 2: Apps (own ScrollViewer, appears when group selected)  -->
                                <Border
                                    Grid.Column="2"
                                    MinWidth="200"
                                    Padding="10"
                                    Background="{DynamicResource SurfaceMediumBrush}"
                                    CornerRadius="8"
                                    Visibility="{Binding IsGroupSelected, Converter={StaticResource BoolToVis}}">
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="*" />
                                        </Grid.RowDefinitions>
                                        <StackPanel Margin="0,0,0,12" Orientation="Horizontal">
                                            <Button
                                                Padding="6,3"
                                                Background="Transparent"
                                                BorderThickness="0"
                                                Command="{Binding BackToGroupsCommand}"
                                                Content="← Back"
                                                Cursor="Hand"
                                                FontSize="11"
                                                Foreground="{DynamicResource ForegroundMutedBrush}">
                                                <Button.Style>
                                                    <Style TargetType="Button">
                                                        <Setter Property="Template">
                                                            <Setter.Value>
                                                                <ControlTemplate TargetType="Button">
                                                                    <Border Padding="{TemplateBinding Padding}" Background="{TemplateBinding Background}">
                                                                        <ContentPresenter />
                                                                    </Border>
                                                                </ControlTemplate>
                                                            </Setter.Value>
                                                        </Setter>
                                                        <Style.Triggers>
                                                            <Trigger Property="IsMouseOver" Value="True">
                                                                <Setter Property="Foreground" Value="#10B981" />
                                                            </Trigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Button.Style>
                                            </Button>
                                            <TextBlock
                                                Margin="10,0,0,0"
                                                FontSize="14"
                                                FontWeight="SemiBold"
                                                Foreground="{DynamicResource ForegroundBrush}"
                                                Text="💻 Apps" />
                                            <TextBlock
                                                Margin="6,0,0,0"
                                                VerticalAlignment="Center"
                                                FontSize="12"
                                                Foreground="{DynamicResource ForegroundMutedBrush}"
                                                Text="{Binding SelectedGroupName, StringFormat='({0})'}" />

                                            <!--  Group Batch Actions  -->
                                            <StackPanel
                                                Margin="10,0,0,0"
                                                VerticalAlignment="Center"
                                                Orientation="Horizontal"
                                                Visibility="{Binding SelectedGroupName, Converter={StaticResource NullToBool}, ConverterParameter=Visible}">
                                                <Button
                                                    Padding="4,2"
                                                    Background="Transparent"
                                                    BorderThickness="0"
                                                    Command="{Binding DataContext.EditGroupCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                    CommandParameter="{Binding SelectedGroupName}"
                                                    Content="✏️"
                                                    Cursor="Hand"
                                                    FontSize="12"
                                                    Foreground="#AAA"
                                                    ToolTip="Batch Edit Group Rules" />
                                                <Button
                                                    Padding="4,2"
                                                    Background="Transparent"
                                                    BorderThickness="0"
                                                    Command="{Binding DataContext.RemoveGroupCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                    CommandParameter="{Binding SelectedGroupName}"
                                                    Content="🗑️"
                                                    Cursor="Hand"
                                                    FontSize="12"
                                                    Foreground="#7F1D1D"
                                                    ToolTip="Delete Entire Group" />
                                            </StackPanel>
                                        </StackPanel>
                                        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                                            <ItemsControl ItemsSource="{Binding SelectedGroupApps}">
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <Border
                                                            Margin="0,0,0,6"
                                                            Padding="12,10"
                                                            CornerRadius="6"
                                                            Cursor="Hand">
                                                            <Border.Style>
                                                                <Style TargetType="Border">
                                                                    <Setter Property="Background" Value="{DynamicResource SurfaceLightBrush}" />
                                                                    <Style.Triggers>
                                                                        <Trigger Property="IsMouseOver" Value="True">
                                                                            <Setter Property="Background" Value="{DynamicResource BorderBrush}" />
                                                                        </Trigger>
                                                                        <DataTrigger Value="True">
                                                                            <DataTrigger.Binding>
                                                                                <MultiBinding Converter="{StaticResource EqualityConverter}">
                                                                                    <Binding Path="AppName" />
                                                                                    <Binding Path="DataContext.SelectedAppName" RelativeSource="{RelativeSource AncestorType=Window}" />
                                                                                </MultiBinding>
                                                                            </DataTrigger.Binding>
                                                                            <Setter Property="Background" Value="{DynamicResource PrimaryAccentBrush}" />
                                                                            <Setter Property="BorderBrush" Value="{DynamicResource PrimaryAccentBrush}" />
                                                                        </DataTrigger>
                                                                    </Style.Triggers>
                                                                </Style>
                                                            </Border.Style>
                                                            <Border.InputBindings>
                                                                <MouseBinding
                                                                    Command="{Binding DataContext.SelectAppCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                                    CommandParameter="{Binding AppName}"
                                                                    MouseAction="LeftClick" />
                                                            </Border.InputBindings>
                                                            <Grid>
                                                                <Grid.ColumnDefinitions>
                                                                    <ColumnDefinition Width="*" />
                                                                    <ColumnDefinition Width="Auto" />
                                                                    <ColumnDefinition Width="Auto" />
                                                                </Grid.ColumnDefinitions>
                                                                <TextBlock
                                                                    VerticalAlignment="Center"
                                                                    FontSize="13"
                                                                    FontWeight="Medium"
                                                                    Foreground="{DynamicResource ForegroundBrush}"
                                                                    Text="{Binding AppName}" />

                                                                <!--  Rule Count Badge  -->
                                                                <Border
                                                                    Grid.Column="1"
                                                                    Margin="0,0,5,0"
                                                                    Padding="8,3"
                                                                    VerticalAlignment="Center"
                                                                    Background="#10B981"
                                                                    CornerRadius="10">
                                                                    <TextBlock
                                                                        FontSize="10"
                                                                        Foreground="White"
                                                                        Text="{Binding RuleCount}" />
                                                                </Border>

                                                                <!--  Edit/Delete Actions  -->
                                                                <StackPanel
                                                                    Grid.Column="2"
                                                                    VerticalAlignment="Center"
                                                                    Orientation="Horizontal">
                                                                    <Button
                                                                        Padding="4"
                                                                        Background="Transparent"
                                                                        BorderThickness="0"
                                                                        Command="{Binding DataContext.EditAppCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                                        CommandParameter="{Binding AppName}"
                                                                        Content="✏️"
                                                                        Cursor="Hand"
                                                                        FontSize="12"
                                                                        Foreground="#AAA"
                                                                        ToolTip="Edit App Rules" />
                                                                    <Button
                                                                        Padding="4"
                                                                        Background="Transparent"
                                                                        BorderThickness="0"
                                                                        Command="{Binding DataContext.RemoveAppCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                                        CommandParameter="{Binding AppName}"
                                                                        Content="🗑️"
                                                                        Cursor="Hand"
                                                                        FontSize="12"
                                                                        Foreground="#EF4444"
                                                                        ToolTip="Delete App" />
                                                                </StackPanel>
                                                            </Grid>
                                                        </Border>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </ScrollViewer>
                                    </Grid>
                                </Border>

                                <GridSplitter
                                    Grid.Column="3"
                                    Width="4"
                                    HorizontalAlignment="Center"
                                    VerticalAlignment="Stretch"
                                    Background="{DynamicResource BorderBrush}"
                                    ResizeBehavior="PreviousAndNext" />

                                <!--  PANEL 3: Rules (own ScrollViewer, shows rules for selected app/group)  -->
                                <Border
                                    Grid.Column="4"
                                    Padding="10"
                                    Background="{DynamicResource SurfaceMediumBrush}"
                                    CornerRadius="8"
                                    Visibility="{Binding IsGroupSelected, Converter={StaticResource BoolToVis}}">
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="*" />
                                        </Grid.RowDefinitions>
                                        <StackPanel Margin="0,0,0,12" Orientation="Horizontal">
                                            <Button
                                                Padding="6,3"
                                                Background="Transparent"
                                                BorderThickness="0"
                                                Command="{Binding BackToAppsCommand}"
                                                Content="← Apps"
                                                Cursor="Hand"
                                                FontSize="11"
                                                Foreground="{DynamicResource ForegroundMutedBrush}"
                                                Visibility="{Binding IsAppSelected, Converter={StaticResource BoolToVis}}">
                                                <Button.Style>
                                                    <Style TargetType="Button">
                                                        <Setter Property="Template">
                                                            <Setter.Value>
                                                                <ControlTemplate TargetType="Button">
                                                                    <Border Padding="{TemplateBinding Padding}" Background="{TemplateBinding Background}">
                                                                        <ContentPresenter />
                                                                    </Border>
                                                                </ControlTemplate>
                                                            </Setter.Value>
                                                        </Setter>
                                                        <Style.Triggers>
                                                            <Trigger Property="IsMouseOver" Value="True">
                                                                <Setter Property="Foreground" Value="#10B981" />
                                                            </Trigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Button.Style>
                                            </Button>
                                            <TextBlock
                                                Margin="10,0,0,0"
                                                FontSize="14"
                                                FontWeight="SemiBold"
                                                Foreground="{DynamicResource ForegroundBrush}"
                                                Text="📋 Rules" />
                                            <TextBlock
                                                Margin="6,0,0,0"
                                                VerticalAlignment="Center"
                                                FontSize="12"
                                                Foreground="{DynamicResource ForegroundMutedBrush}"
                                                Text="{Binding SelectedAppName, StringFormat='({0})', TargetNullValue='(All in group)'}" />

                                            <!--  App Batch Actions  -->
                                            <StackPanel
                                                Margin="10,0,0,0"
                                                VerticalAlignment="Center"
                                                Orientation="Horizontal"
                                                Visibility="{Binding SelectedAppName, Converter={StaticResource NullToBool}, ConverterParameter=Visible}">
                                                <Button
                                                    Padding="4,2"
                                                    Background="Transparent"
                                                    BorderThickness="0"
                                                    Command="{Binding DataContext.EditAppCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                    CommandParameter="{Binding SelectedAppName}"
                                                    Content="✏️"
                                                    Cursor="Hand"
                                                    FontSize="12"
                                                    Foreground="#AAA"
                                                    ToolTip="Batch Edit App Rules" />
                                                <Button
                                                    Padding="4,2"
                                                    Background="Transparent"
                                                    BorderThickness="0"
                                                    Command="{Binding DataContext.RemoveAppCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                    CommandParameter="{Binding SelectedAppName}"
                                                    Content="🗑️"
                                                    Cursor="Hand"
                                                    FontSize="12"
                                                    Foreground="#7F1D1D"
                                                    ToolTip="Delete All Rules for App" />
                                            </StackPanel>
                                        </StackPanel>
                                        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                                            <ItemsControl
                                                ItemsSource="{Binding SelectedGroupRules}"
                                                VirtualizingPanel.IsVirtualizing="True"
                                                VirtualizingPanel.VirtualizationMode="Recycling">
                                                <ItemsControl.ItemsPanel>
                                                    <ItemsPanelTemplate>
                                                        <VirtualizingStackPanel />
                                                    </ItemsPanelTemplate>
                                                </ItemsControl.ItemsPanel>
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <Border
                                                            Margin="0,0,0,6"
                                                            Padding="10"
                                                            CornerRadius="6"
                                                            Cursor="Hand">
                                                            <Border.Style>
                                                                <Style TargetType="Border">
                                                                    <Setter Property="Background" Value="{DynamicResource SurfaceLightBrush}" />
                                                                    <Style.Triggers>
                                                                        <Trigger Property="IsMouseOver" Value="True">
                                                                            <Setter Property="Background" Value="{DynamicResource BorderBrush}" />
                                                                        </Trigger>
                                                                        <DataTrigger Value="True">
                                                                            <DataTrigger.Binding>
                                                                                <MultiBinding Converter="{StaticResource EqualityConverter}">
                                                                                    <Binding Path="." />
                                                                                    <Binding Path="DataContext.SelectedRule" RelativeSource="{RelativeSource AncestorType=Window}" />
                                                                                </MultiBinding>
                                                                            </DataTrigger.Binding>
                                                                            <Setter Property="Background" Value="#3B3B42" />
                                                                            <Setter Property="BorderBrush" Value="{DynamicResource PrimaryAccentBrush}" />
                                                                            <Setter Property="BorderThickness" Value="1" />
                                                                        </DataTrigger>
                                                                    </Style.Triggers>
                                                                </Style>
                                                            </Border.Style>
                                                            <Border.InputBindings>
                                                                <MouseBinding
                                                                    Command="{Binding DataContext.SelectRuleCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                                    CommandParameter="{Binding}"
                                                                    MouseAction="LeftClick" />
                                                            </Border.InputBindings>
                                                            <Grid>
                                                                <Grid.ColumnDefinitions>
                                                                    <ColumnDefinition Width="Auto" />
                                                                    <ColumnDefinition Width="*" />
                                                                    <ColumnDefinition Width="Auto" />
                                                                    <ColumnDefinition Width="Auto" />
                                                                    <ColumnDefinition Width="Auto" />
                                                                    <ColumnDefinition Width="Auto" />
                                                                </Grid.ColumnDefinitions>
                                                                <CheckBox
                                                                    Margin="0,0,10,0"
                                                                    VerticalAlignment="Center"
                                                                    IsChecked="{Binding IsEnabled}" />
                                                                <StackPanel Grid.Column="1">
                                                                    <TextBlock
                                                                        FontSize="12"
                                                                        FontWeight="SemiBold"
                                                                        Foreground="{DynamicResource ForegroundBrush}"
                                                                        Text="{Binding TargetHosts, Converter={StaticResource ListToStr}}" />
                                                                    <TextBlock
                                                                        FontSize="10"
                                                                        Foreground="{DynamicResource ForegroundMutedBrush}"
                                                                        Text="{Binding TargetApps, Converter={StaticResource ListToStr}}" />
                                                                </StackPanel>
                                                                <!--  Inline Action Edit  -->
                                                                <ComboBox
                                                                    Grid.Column="2"
                                                                    Width="90"
                                                                    Margin="8,0"
                                                                    VerticalAlignment="Center"
                                                                    DisplayMemberPath="."
                                                                    ItemsSource="{Binding DataContext.ActionTypes, RelativeSource={RelativeSource AncestorType=Window}}"
                                                                    SelectedItem="{Binding Action}"
                                                                    ToolTip="Action" />

                                                                <!--  Inline Proxy Edit (Visible only if Action=Proxy)  -->
                                                                <ComboBox
                                                                    Grid.Column="3"
                                                                    Width="140"
                                                                    Margin="0,0,8,0"
                                                                    VerticalAlignment="Center"
                                                                    DisplayMemberPath="IpAddress"
                                                                    ItemsSource="{Binding DataContext.Proxies, RelativeSource={RelativeSource AncestorType=Window}}"
                                                                    SelectedValue="{Binding ProxyId}"
                                                                    SelectedValuePath="Id"
                                                                    ToolTip="Select Proxy"
                                                                    Visibility="{Binding Action, Converter={StaticResource ActionToProxyVisConverter}}" />

                                                                <!--  Inline Block Direction (Visible only if Action=Block)  -->
                                                                <ComboBox
                                                                    Grid.Column="3"
                                                                    Width="140"
                                                                    Margin="0,0,8,0"
                                                                    VerticalAlignment="Center"
                                                                    ItemsSource="{Binding DataContext.BlockDirectionTypes, RelativeSource={RelativeSource AncestorType=Window}}"
                                                                    SelectedItem="{Binding BlockDirection}"
                                                                    ToolTip="Block Direction"
                                                                    Visibility="{Binding Action, Converter={StaticResource ActionToBlockVisConverter}}" />
                                                                <!--  EDIT BUTTON with ✏️ icon  -->
                                                                <Button
                                                                    Grid.Column="4"
                                                                    Width="28"
                                                                    Height="28"
                                                                    Margin="0,0,4,0"
                                                                    Command="{Binding DataContext.EditRuleCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                                    CommandParameter="{Binding}"
                                                                    ToolTip="Edit Details">
                                                                    <Button.Style>
                                                                        <Style TargetType="Button">
                                                                            <Setter Property="Background" Value="#1E3A5F" />
                                                                            <Setter Property="Foreground" Value="White" />
                                                                            <Setter Property="Template">
                                                                                <Setter.Value>
                                                                                    <ControlTemplate TargetType="Button">
                                                                                        <Border
                                                                                            Background="{TemplateBinding Background}"
                                                                                            CornerRadius="4"
                                                                                            Cursor="Hand">
                                                                                            <TextBlock
                                                                                                HorizontalAlignment="Center"
                                                                                                VerticalAlignment="Center"
                                                                                                FontSize="12"
                                                                                                Text="✏️" />
                                                                                        </Border>
                                                                                    </ControlTemplate>
                                                                                </Setter.Value>
                                                                            </Setter>
                                                                            <Style.Triggers>
                                                                                <Trigger Property="IsMouseOver" Value="True">
                                                                                    <Setter Property="Background" Value="#3B82F6" />
                                                                                </Trigger>
                                                                            </Style.Triggers>
                                                                        </Style>
                                                                    </Button.Style>
                                                                </Button>
                                                                <!--  DELETE BUTTON with 🗑️ icon  -->
                                                                <Button
                                                                    Grid.Column="5"
                                                                    Width="28"
                                                                    Height="28"
                                                                    Command="{Binding DataContext.RemoveRuleCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                                    CommandParameter="{Binding}"
                                                                    ToolTip="Delete Rule">
                                                                    <Button.Style>
                                                                        <Style TargetType="Button">
                                                                            <Setter Property="Background" Value="#7F1D1D" />
                                                                            <Setter Property="Foreground" Value="White" />
                                                                            <Setter Property="Template">
                                                                                <Setter.Value>
                                                                                    <ControlTemplate TargetType="Button">
                                                                                        <Border
                                                                                            Background="{TemplateBinding Background}"
                                                                                            CornerRadius="4"
                                                                                            Cursor="Hand">
                                                                                            <TextBlock
                                                                                                HorizontalAlignment="Center"
                                                                                                VerticalAlignment="Center"
                                                                                                FontSize="12"
                                                                                                Text="🗑️" />
                                                                                        </Border>
                                                                                    </ControlTemplate>
                                                                                </Setter.Value>
                                                                            </Setter>
                                                                            <Style.Triggers>
                                                                                <Trigger Property="IsMouseOver" Value="True">
                                                                                    <Setter Property="Background" Value="#DC2626" />
                                                                                </Trigger>
                                                                            </Style.Triggers>
                                                                        </Style>
                                                                    </Button.Style>
                                                                </Button>
                                                            </Grid>
                                                        </Border>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </ScrollViewer>
                                    </Grid>
                                </Border>
                            </Grid>

                            <!--  Modern Add Rule Button  -->
                            <Grid Grid.Row="4" Margin="0,10,0,0">
                                <StackPanel HorizontalAlignment="Left" Orientation="Horizontal">
                                    <Button
                                        Padding="16,10"
                                        Command="{Binding OpenRuleModalCommand}"
                                        CommandParameter="{x:Null}"
                                        Style="{StaticResource AccentBtn}">
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock
                                                Margin="0,0,8,0"
                                                FontSize="14"
                                                Text="➕" />
                                            <TextBlock FontSize="14" Text="Add Rule" />
                                        </StackPanel>
                                    </Button>
                                    <Button
                                        Width="50"
                                        Margin="10,0,0,0"
                                        Background="#A03333"
                                        Command="{Binding OpenBulkDeleteModalCommand}"
                                        Content="Del" />
                                </StackPanel>
                            </Grid>
                        </Grid>

                    </TabItem>

                    <TabItem Header="SETTINGS" Tag="Settings">
                        <ScrollViewer VerticalScrollBarVisibility="Auto">
                            <StackPanel Margin="10">
                                <TextBlock
                                    Margin="0,0,0,15"
                                    FontSize="18"
                                    FontWeight="Light"
                                    Text="ROUTER SETTINGS" />

                                <!--  Autostart  -->
                                <Border
                                    Margin="0,0,0,8"
                                    Padding="10,8"
                                    Background="{DynamicResource SurfaceLightBrush}"
                                    CornerRadius="8">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto" />
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="Auto" />
                                        </Grid.ColumnDefinitions>
                                        <TextBlock
                                            Margin="0,0,12,0"
                                            VerticalAlignment="Center"
                                            FontSize="18"
                                            Text="🚀" />
                                        <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                            <TextBlock
                                                FontSize="14"
                                                FontWeight="SemiBold"
                                                Foreground="{DynamicResource ForegroundBrush}"
                                                Text="Autostart" />
                                            <TextBlock
                                                FontSize="11"
                                                Foreground="{DynamicResource ForegroundMutedBrush}"
                                                Text="Start with Windows" />
                                        </StackPanel>
                                        <CheckBox
                                            Grid.Column="2"
                                            VerticalAlignment="Center"
                                            IsChecked="{Binding IsAutoStart}"
                                            Style="{StaticResource ToggleSwitchStyle}" />
                                    </Grid>
                                </Border>

                                <!--  Check Updates  -->
                                <Border
                                    Margin="0,0,0,8"
                                    Padding="10,8"
                                    Background="{DynamicResource SurfaceLightBrush}"
                                    CornerRadius="8">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto" />
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="Auto" />
                                        </Grid.ColumnDefinitions>
                                        <TextBlock
                                            Margin="0,0,12,0"
                                            VerticalAlignment="Center"
                                            FontSize="18"
                                            Text="🔄" />
                                        <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                            <TextBlock
                                                FontSize="14"
                                                FontWeight="SemiBold"
                                                Foreground="{DynamicResource ForegroundBrush}"
                                                Text="Updates" />
                                            <TextBlock
                                                FontSize="11"
                                                Foreground="{DynamicResource ForegroundMutedBrush}"
                                                Text="Check on startup" />
                                        </StackPanel>
                                        <CheckBox
                                            Grid.Column="2"
                                            VerticalAlignment="Center"
                                            IsChecked="{Binding CheckUpdateOnStartup}"
                                            Style="{StaticResource ToggleSwitchStyle}" />
                                    </Grid>
                                </Border>

                                <!--  DNS Protection  -->
                                <Border
                                    Margin="0,0,0,8"
                                    Padding="10"
                                    Background="{DynamicResource SurfaceLightBrush}"
                                    CornerRadius="8">
                                    <StackPanel>
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto" />
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="Auto" />
                                            </Grid.ColumnDefinitions>
                                            <TextBlock
                                                Margin="0,0,12,0"
                                                VerticalAlignment="Center"
                                                FontSize="18"
                                                Text="🛡️" />
                                            <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                <TextBlock
                                                    FontSize="14"
                                                    FontWeight="SemiBold"
                                                    Foreground="{DynamicResource ForegroundBrush}"
                                                    Text="DNS Protection" />
                                                <TextBlock
                                                    FontSize="11"
                                                    Foreground="{DynamicResource ForegroundMutedBrush}"
                                                    Text="Tunnel DNS requests (Admin)" />
                                            </StackPanel>
                                            <CheckBox
                                                Grid.Column="2"
                                                VerticalAlignment="Center"
                                                IsChecked="{Binding IsDnsProtectionEnabled}"
                                                Style="{StaticResource ToggleSwitchStyle}" />
                                        </Grid>

                                        <!--  DNS Settings (Visible if Enabled)  -->
                                        <StackPanel Margin="0,10,0,0" Visibility="{Binding IsDnsProtectionEnabled, Converter={StaticResource BoolToVis}}">
                                            <TextBlock
                                                Margin="0,0,0,5"
                                                Foreground="#AAA"
                                                Text="DNS Provider:" />
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*" />
                                                    <ColumnDefinition Width="Auto" />
                                                </Grid.ColumnDefinitions>
                                                <ComboBox
                                                    DisplayMemberPath="."
                                                    ItemsSource="{Binding DnsProviders}"
                                                    SelectedItem="{Binding SelectedDnsProvider}" />
                                                <TextBox
                                                    Grid.Column="1"
                                                    Width="120"
                                                    Margin="10,0,0,0"
                                                    IsEnabled="{Binding IsDnsCustom}"
                                                    Text="{Binding DnsHost}"
                                                    ToolTip="Custom DNS IP" />
                                            </Grid>
                                        </StackPanel>
                                    </StackPanel>
                                </Border>

                                <!--  WebRTC Protection (Hidden)  -->
                                <Border
                                    Margin="0,0,0,8"
                                    Padding="10,8"
                                    Background="{DynamicResource SurfaceLightBrush}"
                                    CornerRadius="8"
                                    Visibility="Collapsed">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto" />
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="Auto" />
                                        </Grid.ColumnDefinitions>
                                        <TextBlock
                                            Margin="0,0,12,0"
                                            VerticalAlignment="Center"
                                            FontSize="18"
                                            Text="🌐" />
                                        <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                            <TextBlock
                                                FontSize="14"
                                                FontWeight="SemiBold"
                                                Foreground="{DynamicResource ForegroundBrush}"
                                                Text="WebRTC Protection" />
                                            <TextBlock
                                                FontSize="11"
                                                Foreground="{DynamicResource ForegroundMutedBrush}"
                                                Text="Prevent IP leaks via WebRTC" />
                                        </StackPanel>
                                        <CheckBox
                                            Grid.Column="2"
                                            IsChecked="{Binding IsWebRtcBlockingEnabled}"
                                            Style="{StaticResource ToggleSwitchStyle}" />
                                    </Grid>
                                </Border>

                                <!--  TUN Mode (Hidden)  -->


                                <!--  Import/Export & Update Actions  -->
                                <StackPanel Margin="0,15,0,0">
                                    <TextBlock
                                        Margin="0,0,0,10"
                                        FontSize="12"
                                        FontWeight="Bold"
                                        Foreground="{DynamicResource ForegroundMutedBrush}"
                                        Text="DATA &amp; UPDATES" />

                                    <Grid Margin="0,0,0,10">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="10" />
                                            <ColumnDefinition Width="*" />
                                        </Grid.ColumnDefinitions>
                                        <Button
                                            Height="36"
                                            Background="#333"
                                            BorderThickness="0"
                                            Command="{Binding ImportConfigCommand}"
                                            Content="Import Settings"
                                            Cursor="Hand"
                                            Foreground="White" />
                                        <Button
                                            Grid.Column="2"
                                            Height="36"
                                            Background="#333"
                                            BorderThickness="0"
                                            Command="{Binding ExportConfigCommand}"
                                            Content="Export Settings"
                                            Cursor="Hand"
                                            Foreground="White" />
                                    </Grid>

                                    <Border
                                        Padding="12"
                                        Background="{DynamicResource SurfaceLightBrush}"
                                        CornerRadius="8">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="Auto" />
                                            </Grid.ColumnDefinitions>
                                            <StackPanel VerticalAlignment="Center">
                                                <TextBlock
                                                    FontWeight="SemiBold"
                                                    Foreground="{DynamicResource ForegroundBrush}"
                                                    Text="{Binding CurrentVersion, StringFormat='Version: {0}'}" />
                                                <TextBlock
                                                    FontSize="11"
                                                    Foreground="{DynamicResource ForegroundMutedBrush}"
                                                    Text="Check for latest release" />
                                            </StackPanel>
                                            <Button
                                                Grid.Column="1"
                                                Padding="12,6"
                                                Background="#2563EB"
                                                BorderThickness="0"
                                                Command="{Binding CheckUpdateCommand}"
                                                Content="Check Updates"
                                                Cursor="Hand"
                                                Foreground="White"
                                                Style="{StaticResource AccentBtn}" />
                                        </Grid>
                                    </Border>
                                </StackPanel>

                                <Button
                                    Height="40"
                                    Margin="0,20,0,0"
                                    Command="{Binding ToggleProxyCommand}"
                                    FontSize="14"
                                    FontWeight="Bold">
                                    <Button.Style>
                                        <Style BasedOn="{StaticResource {x:Type Button}}" TargetType="Button">
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsProxyRunning}" Value="True">
                                                    <Setter Property="Content" Value="SYSTEM PROXY: ON" />
                                                    <Setter Property="Background" Value="#28A745" />
                                                </DataTrigger>
                                                <DataTrigger Binding="{Binding IsProxyRunning}" Value="False">
                                                    <Setter Property="Content" Value="SYSTEM PROXY: OFF" />
                                                    <Setter Property="Background" Value="#A03333" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Button.Style>

                                </Button>

                                <Button
                                    Height="40"
                                    Margin="0,10,0,0"
                                    Command="{Binding ExitAppCommand}"
                                    Content="EXIT APPLICATION"
                                    FontSize="14"
                                    FontWeight="Bold"
                                    Style="{StaticResource DangerBtn}" />
                            </StackPanel>
                        </ScrollViewer>
                    </TabItem>

                    <TabItem Header="MONITOR" Tag="Monitor">
                        <Grid Margin="10">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition Width="1.2*" />
                            </Grid.ColumnDefinitions>

                            <!--  Left Panel: Process List  -->
                            <Border
                                Grid.Column="0"
                                Margin="0,0,5,0"
                                Padding="16"
                                Background="{DynamicResource SurfaceMediumBrush}"
                                CornerRadius="12">
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="*" />
                                    </Grid.RowDefinitions>

                                    <!--  Header with Filter  -->
                                    <StackPanel Grid.Row="0" Margin="0,0,0,16">
                                        <TextBlock
                                            FontSize="16"
                                            FontWeight="SemiBold"
                                            Foreground="{DynamicResource ForegroundBrush}"
                                            Text="📊 Traffic Monitor" />
                                        <StackPanel Margin="0,12,0,0" Orientation="Horizontal">
                                            <ComboBox
                                                Width="140"
                                                Margin="0,0,10,0"
                                                ItemsSource="{Binding TrafficPeriodModes}"
                                                SelectedItem="{Binding SelectedPeriodMode}" />
                                            <Button
                                                Padding="12,6"
                                                Command="{Binding ApplyFilterCommand}"
                                                Content="Apply"
                                                Style="{StaticResource AccentBtn}" />
                                        </StackPanel>
                                        <StackPanel
                                            Margin="0,8,0,0"
                                            Orientation="Horizontal"
                                            Visibility="{Binding IsDateRangeVisible, Converter={StaticResource BoolToVis}}">
                                            <DatePicker
                                                Width="110"
                                                Margin="0,0,8,0"
                                                SelectedDate="{Binding FilterDateStart}" />
                                            <TextBlock
                                                VerticalAlignment="Center"
                                                Foreground="{DynamicResource ForegroundMutedBrush}"
                                                Text="→" />
                                            <DatePicker
                                                Width="110"
                                                Margin="8,0,0,0"
                                                SelectedDate="{Binding FilterDateEnd}" />
                                        </StackPanel>
                                    </StackPanel>

                                    <TextBlock
                                        Grid.Row="1"
                                        Margin="0,0,0,8"
                                        FontSize="11"
                                        FontWeight="SemiBold"
                                        Foreground="{DynamicResource ForegroundMutedBrush}"
                                        Text="ACTIVE PROCESSES" />

                                    <!--  Process Cards  -->
                                    <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto">
                                        <ItemsControl ItemsSource="{Binding MonitoredProcesses}">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <Border
                                                        Margin="0,0,0,8"
                                                        Padding="12"
                                                        Cursor="Hand">
                                                        <Border.Style>
                                                            <Style TargetType="Border">
                                                                <Setter Property="Background" Value="{DynamicResource SurfaceLightBrush}" />
                                                                <Setter Property="CornerRadius" Value="8" />
                                                                <Style.Triggers>
                                                                    <Trigger Property="IsMouseOver" Value="True">
                                                                        <Setter Property="Background" Value="{DynamicResource BorderBrush}" />
                                                                    </Trigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </Border.Style>
                                                        <Border.InputBindings>
                                                            <MouseBinding
                                                                Command="{Binding DataContext.SelectMonitorProcessCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                                CommandParameter="{Binding}"
                                                                MouseAction="LeftClick" />
                                                        </Border.InputBindings>
                                                        <Grid>
                                                            <Grid.ColumnDefinitions>
                                                                <ColumnDefinition Width="Auto" />
                                                                <ColumnDefinition Width="*" />
                                                                <ColumnDefinition Width="Auto" />
                                                            </Grid.ColumnDefinitions>
                                                            <Image
                                                                Width="24"
                                                                Height="24"
                                                                Margin="0,0,12,0"
                                                                Source="{Binding Icon}" />
                                                            <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                                <TextBlock
                                                                    FontSize="13"
                                                                    FontWeight="SemiBold"
                                                                    Foreground="{DynamicResource ForegroundBrush}"
                                                                    Text="{Binding ProcessName}" />
                                                                <StackPanel Margin="0,4,0,0" Orientation="Horizontal">
                                                                    <TextBlock
                                                                        FontSize="10"
                                                                        Foreground="#10B981"
                                                                        Text="{Binding DownloadSpeedFormatted, StringFormat='↓ {0}'}" />
                                                                    <TextBlock
                                                                        Margin="12,0,0,0"
                                                                        FontSize="10"
                                                                        Foreground="#60A5FA"
                                                                        Text="{Binding UploadSpeedFormatted, StringFormat='↑ {0}'}" />
                                                                </StackPanel>
                                                            </StackPanel>
                                                            <StackPanel
                                                                Grid.Column="2"
                                                                HorizontalAlignment="Right"
                                                                VerticalAlignment="Center">
                                                                <TextBlock
                                                                    FontSize="10"
                                                                    Foreground="#A1A1AA"
                                                                    Text="{Binding TotalDownloadFormatted, StringFormat='DL: {0}'}" />
                                                                <TextBlock
                                                                    Margin="0,2,0,0"
                                                                    FontSize="10"
                                                                    Foreground="#A1A1AA"
                                                                    Text="{Binding TotalUploadFormatted, StringFormat='UL: {0}'}" />
                                                            </StackPanel>
                                                        </Grid>
                                                    </Border>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </ScrollViewer>
                                </Grid>
                            </Border>

                            <GridSplitter
                                Grid.Column="1"
                                Width="4"
                                VerticalAlignment="Stretch"
                                Background="{DynamicResource SurfaceMediumBrush}" />

                            <!--  Right Panel: Connection Details  -->
                            <Border
                                Grid.Column="2"
                                Margin="5,0,0,0"
                                Padding="16"
                                Background="{DynamicResource SurfaceMediumBrush}"
                                CornerRadius="12">
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="*" />
                                    </Grid.RowDefinitions>

                                    <StackPanel
                                        Margin="0,0,0,16"
                                        Orientation="Horizontal"
                                        Visibility="{Binding SelectedMonitorProcess, Converter={StaticResource NullToBool}, ConverterParameter=Visible}">
                                        <TextBlock
                                            FontSize="16"
                                            FontWeight="SemiBold"
                                            Foreground="{DynamicResource ForegroundBrush}"
                                            Text="🔗 Connections" />
                                        <TextBlock
                                            Margin="8,0,0,0"
                                            VerticalAlignment="Center"
                                            FontSize="12"
                                            Foreground="{DynamicResource ForegroundMutedBrush}"
                                            Text="{Binding SelectedMonitorProcess.ProcessName, StringFormat='({0})'}" />
                                    </StackPanel>

                                    <!--  Connection Cards  -->
                                    <ScrollViewer
                                        Grid.Row="1"
                                        VerticalScrollBarVisibility="Auto"
                                        Visibility="{Binding SelectedMonitorProcess, Converter={StaticResource NullToBool}, ConverterParameter=Visible}">
                                        <ItemsControl ItemsSource="{Binding SelectedMonitorProcess.Connections}">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <Border
                                                        Margin="0,0,0,6"
                                                        Padding="12"
                                                        Background="{DynamicResource SurfaceLightBrush}"
                                                        CornerRadius="8">
                                                        <Grid>
                                                            <Grid.ColumnDefinitions>
                                                                <ColumnDefinition Width="*" />
                                                                <ColumnDefinition Width="Auto" />
                                                                <ColumnDefinition Width="Auto" />
                                                            </Grid.ColumnDefinitions>
                                                            <StackPanel>
                                                                <StackPanel Orientation="Horizontal">
                                                                    <Border
                                                                        Padding="6,2"
                                                                        Background="{DynamicResource BorderBrush}"
                                                                        CornerRadius="4">
                                                                        <StackPanel Orientation="Horizontal">
                                                                            <TextBlock FontSize="9" Text="{Binding TypeIcon}" />
                                                                            <TextBlock
                                                                                Margin="4,0,0,0"
                                                                                FontSize="9"
                                                                                FontWeight="SemiBold"
                                                                                Foreground="#A1A1AA"
                                                                                Text="{Binding Type}" />
                                                                        </StackPanel>
                                                                    </Border>
                                                                    <TextBlock
                                                                        Margin="8,0,0,0"
                                                                        FontSize="10"
                                                                        Foreground="{DynamicResource ForegroundMutedBrush}"
                                                                        Text="{Binding TimeStr}" />
                                                                </StackPanel>
                                                                <TextBlock
                                                                    Margin="0,6,0,0"
                                                                    FontSize="12"
                                                                    Foreground="{DynamicResource ForegroundBrush}"
                                                                    Text="{Binding Host}"
                                                                    TextTrimming="CharacterEllipsis" />
                                                            </StackPanel>
                                                            <StackPanel
                                                                Grid.Column="1"
                                                                Margin="12,0"
                                                                VerticalAlignment="Center">
                                                                <StackPanel Orientation="Horizontal">
                                                                    <Image
                                                                        Width="16"
                                                                        Height="12"
                                                                        Margin="0,0,6,0"
                                                                        Source="{Binding FlagUrl}"
                                                                        Visibility="{Binding FlagUrl, Converter={StaticResource NullToBool}, ConverterParameter=Visible}" />
                                                                    <TextBlock
                                                                        FontSize="10"
                                                                        Foreground="{Binding Color}"
                                                                        Text="{Binding Status}" />
                                                                </StackPanel>
                                                                <TextBlock
                                                                    Margin="0,2,0,0"
                                                                    FontSize="9"
                                                                    Foreground="{DynamicResource ForegroundMutedBrush}"
                                                                    Text="{Binding TrafficFormatted}" />
                                                            </StackPanel>
                                                            <Button
                                                                Grid.Column="2"
                                                                Padding="8,4"
                                                                VerticalAlignment="Center"
                                                                Command="{Binding DataContext.OpenRuleModalCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                                CommandParameter="{Binding}"
                                                                Content="➕"
                                                                FontSize="12"
                                                                Style="{StaticResource AccentBtn}"
                                                                ToolTip="Create Rule" />
                                                        </Grid>
                                                    </Border>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </ScrollViewer>

                                    <TextBlock
                                        Grid.Row="1"
                                        HorizontalAlignment="Center"
                                        VerticalAlignment="Center"
                                        FontSize="13"
                                        Foreground="{DynamicResource ForegroundDisabledBrush}"
                                        Text="Select a process to view connections"
                                        Visibility="{Binding SelectedMonitorProcess, Converter={StaticResource InvBoolToVis}}" />
                                </Grid>
                            </Border>
                        </Grid>
                    </TabItem>

                    <TabItem Header="CONNECTION LOGS" Tag="Logs">
                        <Grid Margin="10">
                            <Border
                                Padding="16"
                                Background="{DynamicResource SurfaceMediumBrush}"
                                CornerRadius="12">
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="*" />
                                    </Grid.RowDefinitions>

                                    <!--  Header  -->
                                    <StackPanel
                                        Grid.Row="0"
                                        Margin="0,0,0,16"
                                        Orientation="Horizontal">
                                        <TextBlock
                                            FontSize="16"
                                            FontWeight="SemiBold"
                                            Foreground="{DynamicResource ForegroundBrush}"
                                            Text="📋 Connection History" />
                                        <TextBlock
                                            Margin="12,0,0,0"
                                            VerticalAlignment="Center"
                                            FontSize="12"
                                            Foreground="{DynamicResource ForegroundMutedBrush}"
                                            Text="{Binding Logs.Count, StringFormat='{}{0} entries'}" />
                                        <Button
                                            Margin="16,0,0,0"
                                            Padding="12,6"
                                            Command="{Binding ClearLogsCommand}"
                                            Content="🗑️ Clear All">
                                            <Button.Style>
                                                <Style TargetType="Button">
                                                    <Setter Property="Background" Value="#7F1D1D" />
                                                    <Setter Property="Foreground" Value="White" />
                                                    <Setter Property="BorderThickness" Value="0" />
                                                    <Setter Property="Cursor" Value="Hand" />
                                                    <Setter Property="Template">
                                                        <Setter.Value>
                                                            <ControlTemplate TargetType="Button">
                                                                <Border
                                                                    Padding="{TemplateBinding Padding}"
                                                                    Background="{TemplateBinding Background}"
                                                                    CornerRadius="6">
                                                                    <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
                                                                </Border>
                                                            </ControlTemplate>
                                                        </Setter.Value>
                                                    </Setter>
                                                    <Style.Triggers>
                                                        <Trigger Property="IsMouseOver" Value="True">
                                                            <Setter Property="Background" Value="#DC2626" />
                                                        </Trigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Button.Style>
                                        </Button>
                                    </StackPanel>

                                    <!--  Log Cards  -->
                                    <ScrollViewer
                                        Grid.Row="1"
                                        VerticalScrollBarVisibility="Auto"
                                        VirtualizingPanel.IsVirtualizing="True"
                                        VirtualizingPanel.VirtualizationMode="Recycling">
                                        <ItemsControl ItemsSource="{Binding Logs}" VirtualizingPanel.IsVirtualizing="True">
                                            <ItemsControl.ItemsPanel>
                                                <ItemsPanelTemplate>
                                                    <VirtualizingStackPanel />
                                                </ItemsPanelTemplate>
                                            </ItemsControl.ItemsPanel>
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <Border
                                                        Margin="0,0,0,6"
                                                        Padding="14"
                                                        Background="{DynamicResource SurfaceLightBrush}"
                                                        CornerRadius="8">
                                                        <Grid>
                                                            <Grid.ColumnDefinitions>
                                                                <ColumnDefinition Width="Auto" />
                                                                <ColumnDefinition Width="*" />
                                                                <ColumnDefinition Width="Auto" />
                                                                <ColumnDefinition Width="Auto" />
                                                            </Grid.ColumnDefinitions>

                                                            <!--  App Icon  -->
                                                            <Image
                                                                Width="28"
                                                                Height="28"
                                                                Margin="0,0,14,0"
                                                                VerticalAlignment="Center"
                                                                Source="{Binding AppIcon}" />

                                                            <!--  Main Content  -->
                                                            <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                                <StackPanel Orientation="Horizontal">
                                                                    <!--  Type Badge  -->
                                                                    <Border
                                                                        Padding="6,2"
                                                                        Background="{DynamicResource BorderBrush}"
                                                                        CornerRadius="4">
                                                                        <StackPanel Orientation="Horizontal">
                                                                            <TextBlock FontSize="10" Text="{Binding TypeIcon}" />
                                                                            <TextBlock
                                                                                Margin="4,0,0,0"
                                                                                FontSize="10"
                                                                                FontWeight="SemiBold"
                                                                                Foreground="#A1A1AA"
                                                                                Text="{Binding TypeStr}" />
                                                                        </StackPanel>
                                                                    </Border>
                                                                    <TextBlock
                                                                        Margin="10,0,0,0"
                                                                        VerticalAlignment="Center"
                                                                        FontSize="11"
                                                                        Foreground="{DynamicResource ForegroundMutedBrush}"
                                                                        Text="{Binding Time}" />
                                                                    <TextBlock
                                                                        Margin="10,0,0,0"
                                                                        VerticalAlignment="Center"
                                                                        FontSize="12"
                                                                        FontWeight="SemiBold"
                                                                        Foreground="#A1A1AA"
                                                                        Text="{Binding ProcessName}" />
                                                                </StackPanel>
                                                                <TextBlock
                                                                    Margin="0,6,0,0"
                                                                    FontSize="13"
                                                                    Foreground="{DynamicResource ForegroundBrush}"
                                                                    Text="{Binding Host}"
                                                                    TextTrimming="CharacterEllipsis" />
                                                            </StackPanel>

                                                            <!--  Result Badge  -->
                                                            <StackPanel
                                                                Grid.Column="2"
                                                                Margin="12,0"
                                                                VerticalAlignment="Center">
                                                                <StackPanel Orientation="Horizontal">
                                                                    <Image
                                                                        Width="20"
                                                                        Height="15"
                                                                        Margin="0,0,6,0"
                                                                        RenderOptions.BitmapScalingMode="HighQuality"
                                                                        Source="{Binding CountryFlagUrl}"
                                                                        Visibility="{Binding CountryFlagUrl, Converter={StaticResource NullToBool}, ConverterParameter=Visible}" />
                                                                    <TextBlock
                                                                        FontSize="12"
                                                                        FontWeight="SemiBold"
                                                                        Foreground="{Binding Color}"
                                                                        Text="{Binding Result}" />
                                                                </StackPanel>
                                                            </StackPanel>

                                                            <!--  Action Button  -->
                                                            <Button
                                                                Grid.Column="3"
                                                                Padding="10,6"
                                                                VerticalAlignment="Center"
                                                                Command="{Binding DataContext.OpenRuleModalCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                                CommandParameter="{Binding}"
                                                                Content="➕ Rule"
                                                                FontSize="11"
                                                                Style="{StaticResource AccentBtn}"
                                                                ToolTip="Create Traffic Rule" />
                                                        </Grid>
                                                    </Border>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </ScrollViewer>
                                </Grid>
                            </Border>
                        </Grid>
                    </TabItem>

                    <!--  App Logs Tab - Shows application events, WebRTC blocks, errors  -->
                    <!--  APP LOGS TAB (Disabled)  -->
                    <!--<TabItem>
                    <TabItem.Header>
                        <StackPanel
                            Margin="8,4"
                            Orientation="Horizontal"
                            ToolTip="Application Logs">
                            <TextBlock
                                VerticalAlignment="Center"
                                FontSize="16"
                                Text="📜" />
                            <TextBlock
                                Margin="8,0,0,0"
                                VerticalAlignment="Center"
                                FontSize="13"
                                FontWeight="SemiBold"
                                Text="APP LOGS" />
                        </StackPanel>
                    </TabItem.Header>
                    <Grid Margin="20">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="*" />
                        </Grid.RowDefinitions>

                        <StackPanel
                            Margin="0,0,0,15"
                            HorizontalAlignment="Right"
                            Orientation="Horizontal">
                            <Button
                                Width="100"
                                Height="32"
                                Command="{Binding ClearLogsCommand}"
                                Content="Clear Logs"
                                Style="{StaticResource ModernButtonStyle}" />
                        </StackPanel>

                        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                            <ItemsControl ItemsSource="{Binding AppLogs}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <StackPanel />
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border
                                            Margin="0,0,0,4"
                                            Padding="8,6"
                                            Background="{DynamicResource SurfaceMediumBrush}"
                                            CornerRadius="4">
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="80" />
                                                    <ColumnDefinition Width="70" />
                                                    <ColumnDefinition Width="120" />
                                                    <ColumnDefinition Width="*" />
                                                </Grid.ColumnDefinitions>
                                                <TextBlock
                                                    VerticalAlignment="Center"
                                                    FontSize="11"
                                                    Foreground="{DynamicResource ForegroundMutedBrush}"
                                                    Text="{Binding TimeStr}" />
                                                <Border
                                                    Grid.Column="1"
                                                    HorizontalAlignment="Left"
                                                    VerticalAlignment="Center"
                                                    CornerRadius="3">
                                                    <Border.Style>
                                                        <Style TargetType="Border">
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding Level}" Value="Debug">
                                                                    <Setter Property="Background" Value="{DynamicResource SurfaceLightBrush}" />
                                                                </DataTrigger>
                                                                <DataTrigger Binding="{Binding Level}" Value="Info">
                                                                    <Setter Property="Background" Value="#1E3A5F" />
                                                                </DataTrigger>
                                                                <DataTrigger Binding="{Binding Level}" Value="Warning">
                                                                    <Setter Property="Background" Value="#78350F" />
                                                                </DataTrigger>
                                                                <DataTrigger Binding="{Binding Level}" Value="Error">
                                                                    <Setter Property="Background" Value="#7F1D1D" />
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </Border.Style>
                                                    <TextBlock
                                                        Margin="6,2"
                                                        FontSize="10"
                                                        FontWeight="SemiBold"
                                                        Foreground="{Binding Color}"
                                                        Text="{Binding LevelStr}" />
                                                </Border>
                                                <TextBlock
                                                    Grid.Column="2"
                                                    VerticalAlignment="Center"
                                                    FontSize="11"
                                                    Foreground="#A1A1AA"
                                                    Text="{Binding Source}"
                                                    TextTrimming="CharacterEllipsis" />
                                                <TextBlock
                                                    Grid.Column="3"
                                                    VerticalAlignment="Center"
                                                    FontSize="12"
                                                    Foreground="{DynamicResource ForegroundBrush}"
                                                    Text="{Binding Message}"
                                                    TextWrapping="Wrap" />
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>
                    </Grid>
                </TabItem>-->
                </TabControl>
            </Grid>
        </Grid>

        <!--  Modern Rule Modal  -->
        <Grid
            x:Name="RuleModalOverlay"
            Grid.RowSpan="2"
            Panel.ZIndex="999"
            d:IsHidden="True"
            Visibility="{Binding IsModalVisible, Converter={StaticResource BoolToVis}}">

            <!--  Backdrop  -->
            <Border Background="#DD0A0A0D" />

            <!--  Modal Card  -->
            <Border
                Width="520"
                Padding="28"
                HorizontalAlignment="Center"
                VerticalAlignment="Center"
                Background="{DynamicResource SurfaceMediumBrush}"
                BorderBrush="#27272A"
                BorderThickness="1"
                CornerRadius="16">
                <Border.Effect>
                    <DropShadowEffect
                        BlurRadius="40"
                        Opacity="0.6"
                        ShadowDepth="0"
                        Color="Black" />
                </Border.Effect>
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>

                    <!--  Header  -->
                    <StackPanel Margin="0,0,0,24">
                        <TextBlock
                            FontSize="22"
                            FontWeight="SemiBold"
                            Foreground="White"
                            Text="{Binding ModalTitle}" />
                        <TextBlock
                            Margin="0,6,0,0"
                            FontSize="13"
                            Foreground="{DynamicResource ForegroundMutedBrush}"
                            Text="{Binding ModalSubtitle}" />
                    </StackPanel>

                    <!--  Content  -->
                    <StackPanel Grid.Row="1">
                        <!--  Process Name with File Browser  -->
                        <StackPanel Visibility="{Binding IsRenameGroupMode, Converter={StaticResource InvBoolToVis}}">
                            <TextBlock
                                Margin="0,0,0,8"
                                FontSize="12"
                                FontWeight="Medium"
                                Foreground="#A1A1AA"
                                Text="PROCESS NAME" />
                            <Grid Margin="0,0,0,16">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>
                                <TextBox
                                    Grid.Column="0"
                                    Padding="12,10"
                                    Text="{Binding ModalProcessName, UpdateSourceTrigger=PropertyChanged}" />
                                <Button
                                    Grid.Column="1"
                                    MinWidth="80"
                                    Margin="8,0,0,0"
                                    Padding="12,8"
                                    Command="{Binding BrowseAppCommand}"
                                    Content="📁 Browse"
                                    FontSize="13"
                                    ToolTip="Browse .exe or .lnk file" />
                            </Grid>
                        </StackPanel>

                        <!--  Host Pattern  -->
                        <StackPanel Visibility="{Binding IsRenameGroupMode, Converter={StaticResource InvBoolToVis}}">
                            <TextBlock
                                Margin="0,0,0,8"
                                FontSize="12"
                                FontWeight="Medium"
                                Foreground="#A1A1AA"
                                Text="HOST PATTERN" />
                            <TextBox
                                Margin="0,0,0,16"
                                Padding="12,10"
                                Text="{Binding ModalHost, UpdateSourceTrigger=PropertyChanged}" />
                        </StackPanel>

                        <!--  Group Selection  -->
                        <TextBlock
                            Margin="0,0,0,8"
                            FontSize="12"
                            FontWeight="Medium"
                            Foreground="#A1A1AA"
                            Text="GROUP" />
                        <TextBox
                            Margin="0,0,0,16"
                            Padding="12,10"
                            Text="{Binding ModalGroupName, UpdateSourceTrigger=PropertyChanged}" />

                        <!--  Action and Mode Row  -->
                        <Grid Margin="0,0,0,16" Visibility="{Binding IsRenameGroupMode, Converter={StaticResource InvBoolToVis}}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="16" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>

                            <StackPanel Grid.Column="0">
                                <TextBlock
                                    Margin="0,0,0,8"
                                    FontSize="12"
                                    FontWeight="Medium"
                                    Foreground="#A1A1AA"
                                    Text="ACTION" />
                                <ComboBox
                                    MinHeight="40"
                                    Padding="12,10"
                                    ItemsSource="{Binding ActionTypes}"
                                    SelectedItem="{Binding ModalAction}" />
                            </StackPanel>

                            <StackPanel Grid.Column="2">
                                <TextBlock
                                    Margin="0,0,0,8"
                                    FontSize="12"
                                    FontWeight="Medium"
                                    Foreground="#A1A1AA"
                                    Text="TARGET LIST" />
                                <ComboBox
                                    MinHeight="40"
                                    Padding="12,10"
                                    ItemsSource="{Binding ModeTypes}"
                                    SelectedItem="{Binding ModalTargetMode}" />
                            </StackPanel>
                        </Grid>

                        <!--  Block Direction  -->
                        <StackPanel Margin="0,0,0,16" Visibility="{Binding IsRenameGroupMode, Converter={StaticResource InvBoolToVis}}">
                            <StackPanel Visibility="{Binding ModalAction, Converter={StaticResource ActionToBlockVisConverter}}">
                                <TextBlock
                                    Margin="0,0,0,8"
                                    FontSize="12"
                                    FontWeight="Medium"
                                    Foreground="#A1A1AA"
                                    Text="BLOCK DIRECTION" />
                                <ComboBox
                                    MinHeight="40"
                                    Padding="12,10"
                                    ItemsSource="{Binding BlockDirectionTypes}"
                                    SelectedItem="{Binding ModalBlockDirection}" />
                            </StackPanel>
                        </StackPanel>



                        <!--  Schedule  -->
                        <StackPanel Margin="0,0,0,16" Visibility="{Binding IsRenameGroupMode, Converter={StaticResource InvBoolToVis}}">
                            <CheckBox
                                Margin="0,0,0,8"
                                Content="Enable Schedule"
                                Foreground="{DynamicResource ForegroundBrush}"
                                IsChecked="{Binding ModalIsScheduleEnabled}" />
                            <Grid Visibility="{Binding ModalIsScheduleEnabled, Converter={StaticResource BoolToVis}}">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="16" />
                                    <ColumnDefinition Width="*" />
                                </Grid.ColumnDefinitions>
                                <StackPanel>
                                    <TextBlock
                                        Margin="0,0,0,4"
                                        FontSize="11"
                                        Foreground="#666"
                                        Text="Start (HH:mm)" />
                                    <TextBox
                                        Padding="10"
                                        Text="{Binding ModalTimeStart, UpdateSourceTrigger=PropertyChanged}"
                                        ToolTip="Start Time (e.g. 09:00)" />
                                </StackPanel>
                                <StackPanel Grid.Column="2">
                                    <TextBlock
                                        Margin="0,0,0,4"
                                        FontSize="11"
                                        Foreground="#666"
                                        Text="End (HH:mm)" />
                                    <TextBox
                                        Padding="10"
                                        Text="{Binding ModalTimeEnd, UpdateSourceTrigger=PropertyChanged}"
                                        ToolTip="End Time (e.g. 17:00)" />
                                </StackPanel>
                            </Grid>
                        </StackPanel>

                        <!--  Proxy Selection  -->
                        <StackPanel Visibility="{Binding IsRenameGroupMode, Converter={StaticResource InvBoolToVis}}">
                            <StackPanel Visibility="{Binding IsModalProxyRequired, Converter={StaticResource BoolToVis}}">
                                <TextBlock
                                    Margin="0,0,0,8"
                                    FontSize="12"
                                    FontWeight="Medium"
                                    Foreground="#A1A1AA"
                                    Text="SELECT PROXY" />
                                <ComboBox
                                    MinHeight="40"
                                    Padding="12,10"
                                    ItemsSource="{Binding Proxies}"
                                    SelectedItem="{Binding ModalSelectedProxy}">
                                    <ComboBox.ItemTemplate>
                                        <DataTemplate>
                                            <StackPanel Orientation="Horizontal">
                                                <TextBlock
                                                    Margin="0,0,8,0"
                                                    FontSize="14"
                                                    Text="{Binding CountryEmoji}" />
                                                <TextBlock Text="{Binding IpAddress}" />
                                                <TextBlock
                                                    Margin="4,0,0,0"
                                                    Foreground="{DynamicResource ForegroundMutedBrush}"
                                                    Text=":" />
                                                <TextBlock Foreground="{DynamicResource ForegroundMutedBrush}" Text="{Binding Port}" />
                                            </StackPanel>
                                        </DataTemplate>
                                    </ComboBox.ItemTemplate>
                                </ComboBox>
                            </StackPanel>
                        </StackPanel>
                    </StackPanel>

                    <!--  Footer Buttons  -->
                    <Grid Grid.Row="2" Margin="0,24,0,0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <Button
                            Grid.Column="1"
                            MinWidth="100"
                            Margin="0,0,12,0"
                            Padding="16,10"
                            Command="{Binding CloseModalCommand}"
                            Content="Cancel" />
                        <Button
                            Grid.Column="2"
                            MinWidth="120"
                            Padding="16,10"
                            Command="{Binding SaveModalRuleCommand}"
                            Content="💾 Save Rule"
                            Style="{StaticResource AccentBtn}" />
                    </Grid>
                </Grid>
            </Border>
        </Grid>

        <Grid
            x:Name="ProxyModalOverlay"
            Grid.RowSpan="2"
            Panel.ZIndex="1000"
            d:IsHidden="True"
            Background="#CC000000"
            Visibility="{Binding IsProxyModalVisible, Converter={StaticResource BoolToVis}}">
            <Border
                Width="350"
                Padding="25"
                HorizontalAlignment="Center"
                VerticalAlignment="Center"
                Background="#252526"
                BorderBrush="#007ACC"
                BorderThickness="1"
                CornerRadius="8">
                <Border.Effect>
                    <DropShadowEffect
                        BlurRadius="20"
                        Opacity="0.5"
                        ShadowDepth="5" />
                </Border.Effect>
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>

                    <TextBlock
                        Margin="0,0,0,20"
                        HorizontalAlignment="Center"
                        FontSize="20"
                        FontWeight="Bold"
                        Foreground="White"
                        Text="{Binding ProxyModalTitle}" />

                    <StackPanel Grid.Row="1">
                        <TextBlock
                            Margin="0,0,0,5"
                            Foreground="#AAA"
                            Text="Proxy Type" />
                        <ComboBox
                            Margin="0,0,0,15"
                            Padding="5"
                            ItemsSource="{Binding ProxyTypes}"
                            SelectedItem="{Binding ProxyModalType}" />

                        <Grid Margin="0,0,0,15">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="2*" />
                                <ColumnDefinition Width="10" />
                                <ColumnDefinition Width="1*" />
                            </Grid.ColumnDefinitions>
                            <StackPanel>
                                <TextBlock
                                    Margin="0,0,0,5"
                                    Foreground="#AAA"
                                    Text="IP Address" />
                                <TextBox Padding="5" Text="{Binding ProxyModalIp}" />
                            </StackPanel>
                            <StackPanel Grid.Column="2">
                                <TextBlock
                                    Margin="0,0,0,5"
                                    Foreground="#AAA"
                                    Text="Port" />
                                <TextBox Padding="5" Text="{Binding ProxyModalPort}" />
                            </StackPanel>
                        </Grid>

                        <TextBlock
                            Margin="0,0,0,5"
                            Foreground="#AAA"
                            Text="Username (Optional)" />
                        <TextBox
                            Margin="0,0,0,15"
                            Padding="5"
                            Text="{Binding ProxyModalUser}" />

                        <TextBlock
                            Margin="0,0,0,5"
                            Foreground="#AAA"
                            Text="Password (Optional)" />
                        <TextBox
                            Margin="0,0,0,15"
                            Padding="5"
                            Text="{Binding ProxyModalPass}" />

                        <CheckBox
                            Margin="0,0,0,5"
                            Content="Use TLS (Modern Secure Proxy)"
                            Foreground="White"
                            IsChecked="{Binding ProxyModalUseTls}" />
                        <CheckBox
                            Margin="0,0,0,15"
                            Content="Use SSL (Legacy/Compat Mode)"
                            Foreground="White"
                            IsChecked="{Binding ProxyModalUseSsl}" />

                    </StackPanel>

                    <StackPanel
                        Grid.Row="2"
                        Margin="0,25,0,0"
                        HorizontalAlignment="Right"
                        Orientation="Horizontal">
                        <Button
                            Width="80"
                            Height="30"
                            Margin="0,0,10,0"
                            Background="#444"
                            Command="{Binding CloseProxyModalCommand}"
                            Content="Cancel" />
                        <Button
                            Width="100"
                            Height="30"
                            Command="{Binding SaveProxyModalCommand}"
                            Content="Save Proxy"
                            Style="{StaticResource AccentBtn}" />
                    </StackPanel>
                </Grid>
            </Border>
        </Grid>

        <Grid
            x:Name="DeleteModalOverlay"
            Grid.RowSpan="2"
            Panel.ZIndex="1100"
            d:IsHidden="True"
            Visibility="{Binding IsDeleteModalVisible, Converter={StaticResource BoolToVis}}">
            <Border Background="#DD0A0A0D" />
            <Border
                Width="380"
                Padding="24"
                HorizontalAlignment="Center"
                VerticalAlignment="Center"
                Background="{DynamicResource SurfaceMediumBrush}"
                BorderBrush="#27272A"
                BorderThickness="1"
                CornerRadius="16">
                <Border.Effect>
                    <DropShadowEffect
                        BlurRadius="40"
                        Opacity="0.6"
                        ShadowDepth="0"
                        Color="Black" />
                </Border.Effect>
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>

                    <StackPanel Margin="0,0,0,24">
                        <TextBlock
                            FontSize="20"
                            FontWeight="SemiBold"
                            Foreground="White"
                            Text="🗑️ Delete Rules" />
                        <TextBlock
                            Margin="0,6,0,0"
                            FontSize="13"
                            Foreground="{DynamicResource ForegroundMutedBrush}"
                            Text="Choose what you want to delete." />
                    </StackPanel>

                    <StackPanel Grid.Row="1" Margin="0,0,0,24">
                        <Button
                            Margin="0,0,0,10"
                            Padding="16,10"
                            HorizontalContentAlignment="Left"
                            Command="{Binding DeleteAppRulesCommand}"
                            IsEnabled="{Binding IsDeleteAppEnabled}"
                            Style="{StaticResource AccentBtn}">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="*" />
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="📱" />
                                <StackPanel Grid.Column="1" Margin="10,0,0,0">
                                    <TextBlock FontWeight="SemiBold" Text="Delete App Rules" />
                                    <TextBlock
                                        FontSize="11"
                                        Opacity="0.8"
                                        Text="{Binding SelectedAppName, StringFormat='All rules for {0}'}" />
                                </StackPanel>
                            </Grid>
                        </Button>

                        <Button
                            Padding="16,10"
                            HorizontalContentAlignment="Left"
                            Command="{Binding DeleteGroupRulesCommand}"
                            IsEnabled="{Binding IsDeleteGroupEnabled}"
                            Style="{StaticResource AccentBtn}">
                            <Button.Background>
                                <SolidColorBrush Color="{DynamicResource SurfaceLight}" />
                            </Button.Background>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="*" />
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="📁" />
                                <StackPanel Grid.Column="1" Margin="10,0,0,0">
                                    <TextBlock FontWeight="SemiBold" Text="Delete Group Rules" />
                                    <TextBlock
                                        FontSize="11"
                                        Opacity="0.8"
                                        Text="{Binding SelectedGroupName, StringFormat='All rules in {0}'}" />
                                </StackPanel>
                            </Grid>
                        </Button>
                    </StackPanel>

                    <Button
                        Grid.Row="2"
                        Padding="12,8"
                        Command="{Binding CloseDeleteModalCommand}"
                        Content="Cancel" />
                </Grid>
            </Border>
        </Grid>



        <Grid
            x:Name="UpdateModalOverlay"
            Grid.RowSpan="2"
            Panel.ZIndex="2000"
            d:IsHidden="True"
            Background="#CC000000"
            Visibility="{Binding IsUpdateModalVisible, Converter={StaticResource BoolToVis}}">
            <Border
                Width="400"
                Padding="30"
                HorizontalAlignment="Center"
                VerticalAlignment="Center"
                Background="#252526"
                BorderBrush="#007ACC"
                BorderThickness="1"
                CornerRadius="8">
                <Border.Effect>
                    <DropShadowEffect
                        BlurRadius="20"
                        Opacity="0.5"
                        ShadowDepth="5" />
                </Border.Effect>
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>

                    <StackPanel
                        Margin="0,0,0,20"
                        HorizontalAlignment="Center"
                        Orientation="Horizontal">
                        <TextBlock
                            Margin="0,0,10,0"
                            VerticalAlignment="Center"
                            FontSize="24"
                            Text="♻️" />
                        <TextBlock
                            VerticalAlignment="Center"
                            FontSize="20"
                            FontWeight="Bold"
                            Foreground="White"
                            Text="Updating Application" />
                    </StackPanel>

                    <Grid Grid.Row="1" Margin="0,0,0,5">
                        <ProgressBar
                            Height="20"
                            Background="#333"
                            BorderThickness="0"
                            Foreground="#007ACC"
                            Maximum="100"
                            Value="{Binding UpdateProgress}" />
                        <TextBlock
                            HorizontalAlignment="Center"
                            VerticalAlignment="Center"
                            FontSize="12"
                            FontWeight="Bold"
                            Foreground="White"
                            Text="{Binding UpdateProgress, StringFormat='{}{0}%'}">
                            <TextBlock.Effect>
                                <DropShadowEffect
                                    BlurRadius="2"
                                    ShadowDepth="1"
                                    Color="Black" />
                            </TextBlock.Effect>
                        </TextBlock>
                    </Grid>

                    <TextBlock
                        Grid.Row="2"
                        Margin="0,0,0,15"
                        HorizontalAlignment="Center"
                        FontSize="11"
                        Foreground="#888"
                        Text="{Binding UpdateDetailText}" />

                    <TextBlock
                        Grid.Row="3"
                        HorizontalAlignment="Center"
                        FontSize="14"
                        FontWeight="SemiBold"
                        Foreground="#AAA"
                        Text="{Binding UpdateStatusText}" />

                </Grid>
            </Border>
        </Grid>

        <!--  Confirmation / Message Modal  -->
        <Grid Background="#AA000000" Visibility="{Binding IsConfirmModalVisible, Converter={StaticResource BoolToVis}}">
            <Border
                Width="400"
                Padding="20"
                HorizontalAlignment="Center"
                VerticalAlignment="Center"
                Background="{DynamicResource SurfaceMediumBrush}"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="1"
                CornerRadius="8">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>

                    <TextBlock
                        Grid.Row="0"
                        Margin="0,0,0,10"
                        FontSize="18"
                        FontWeight="Bold"
                        Foreground="{DynamicResource ForegroundBrush}"
                        Text="{Binding ConfirmTitle}" />

                    <TextBlock
                        Grid.Row="1"
                        Margin="0,5,0,20"
                        FontSize="14"
                        Foreground="#A1A1AA"
                        Text="{Binding ConfirmMessage}"
                        TextWrapping="Wrap" />

                    <StackPanel
                        Grid.Row="2"
                        HorizontalAlignment="Right"
                        Orientation="Horizontal">
                        <Button
                            Command="{Binding CloseConfirmModalCommand}"
                            Content="Cancel"
                            Visibility="{Binding IsModalCancelVisible, Converter={StaticResource BoolToVis}}" />
                        <Button
                            Margin="10,0,0,0"
                            Command="{Binding ConfirmActionCommand}"
                            Content="OK"
                            Style="{StaticResource AccentBtn}" />
                    </StackPanel>
                </Grid>
            </Border>
        </Grid>
    </Grid>
</Window>
